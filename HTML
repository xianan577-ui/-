<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rynx - AI聊天世界</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入Google Fonts字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@300;400;500;700;900&family=Long+Cang&family=Liu+Jian+Mao+Cao&display=swap" rel="stylesheet">
    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* 允许文本输入区域选择 */
        .chat-input, .form-input, .form-textarea, .comment-input,
        .form-textarea, .custom-css-input, textarea, input[type="text"],
        input[type="password"], input[type="number"], input[type="email"],
        input[type="search"], input[type="tel"], input[type="url"] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        :root {
            /* 主题色 */
            --primary-color: #07c160; /* 微信绿 */
            --secondary-color: #1aad19;
            --accent-color: #10aeff;
            --danger-color: #fa5151;
            --warning-color: #fa9d3b;
            --purple-color: #8a2be2;
            
            /* 背景色 */
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --sidebar-bg: #2e3238;
            --header-bg: #ededed;
            
            /* 文字色 */
            --text-color: #333333;
            --text-secondary: #888888;
            --text-light: #aaaaaa;
            --text-white: #ffffff;
            
            /* 边框色 */
            --border-color: #e0e0e0;
            --border-dark: #3a3a3a;
            
            /* 聊天颜色 */
            --chat-user-bg: #95ec69;
            --chat-ai-bg: #ffffff;
            --chat-system-bg: #e6e6e6;
            
            /* 尺寸 */
            --nav-height: 60px;
            --header-height: 55px;
            --avatar-size: 45px;
            --message-border-radius: 5px;
        }
        
        /* 暗色模式变量 */
        .dark-mode {
            --primary-color: #07c160;
            --secondary-color: #1aad19;
            --accent-color: #10aeff;
            --danger-color: #fa5151;
            --warning-color: #fa9d3b;
            --purple-color: #8a2be2;
            
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --sidebar-bg: #2e3238;
            --header-bg: #1c1c1c;
            
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-light: #707070;
            --text-white: #ffffff;
            
            --border-color: #3a3a3a;
            --border-dark: #4a4a4a;
            
            --chat-user-bg: #2a7d2a;
            --chat-ai-bg: #2d2d2d;
            --chat-system-bg: #3a3a3a;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            font-size: 16px;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* 字体样式类 */
        .font-default {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
        }
        
        .font-elegant {
            font-family: 'Ma Shan Zheng', 'Noto Sans SC', cursive;
        }
        
        .font-cute {
            font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', cursive;
        }
        
        .font-tech {
            font-family: 'ZCOOL QingKe HuangYou', 'Noto Sans SC', sans-serif;
        }
        
        .font-classic {
            font-family: 'ZCOOL XiaoWei', 'Noto Sans SC', serif;
        }
        
        .font-calligraphy {
            font-family: 'Liu Jian Mao Cao', 'Noto Sans SC', cursive;
        }
        
        .font-long {
            font-family: 'Long Cang', 'Noto Sans SC', cursive;
        }
        
        /* 启动页 */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        
        .splash-hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .rynx-logo {
            font-size: 4.5rem;
            font-weight: 900;
            color: white;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(7, 193, 96, 0.8);
            animation: pulse 2s infinite, float 3s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.3s;
            padding: 20px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .rynx-logo:hover {
            transform: scale(1.05);
        }
        
        @keyframes pulse {
            0%, 100% { text-shadow: 0 0 20px rgba(7, 193, 96, 0.8); }
            50% { text-shadow: 0 0 30px rgba(7, 193, 96, 0.9), 0 0 40px rgba(7, 193, 96, 0.6); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* 主应用容器 */
        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .app-visible {
            opacity: 1;
        }
        
        /* 顶部标题栏 */
        .header {
            height: var(--header-height);
            background-color: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-title i {
            color: var(--primary-color);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .header-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-color);
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .header-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            position: relative;
        }
        
        /* 页面容器 */
        .pages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            position: relative;
            padding-bottom: 70px;
            overscroll-behavior: contain;
        }
        
        .page {
            width: 100%;
            min-height: 100%;
            display: none;
            padding-bottom: 80px;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 底部导航栏 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            height: 100%;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            text-decoration: none;
            position: relative;
            min-height: 60px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 400;
        }
        
        .nav-badge {
            position: absolute;
            top: 8px;
            right: calc(50% - 10px);
            background-color: var(--danger-color);
            color: white;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        /* 聊天列表页面 */
        .chat-list-container {
            padding-top: 10px;
        }
        
        .search-box {
            padding: 10px 15px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
        }
        
        .search-input:focus {
            border-color: var(--primary-color);
        }
        
        .search-icon {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 16px 15px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
            min-height: 70px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .chat-item:hover {
            background-color: var(--bg-color);
        }
        
        .avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        /* 头像框样式 - 可自定义 */
        .avatar-frame {
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1;
        }
        
        .avatar-frame-default {
            border: 2px solid var(--primary-color);
        }
        
        .avatar-frame-circle {
            border: 3px solid var(--primary-color);
            border-radius: 50%;
        }
        
        .avatar-frame-heart::before {
            content: '❤️';
            position: absolute;
            top: -15px;
            right: -5px;
            font-size: 1.2rem;
            z-index: 2;
        }
        
        .avatar-frame-star::before {
            content: '⭐';
            position: absolute;
            top: -15px;
            right: -5px;
            font-size: 1.2rem;
            z-index: 2;
        }
        
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            position: relative;
            z-index: 0;
        }
        
        .chat-info {
            flex: 1;
            margin-left: 12px;
            overflow: hidden;
        }
        
        .chat-name-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .chat-name {
            font-weight: 500;
            font-size: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-time {
            font-size: 0.75rem;
            color: var(--text-light);
            flex-shrink: 0;
        }
        
        .chat-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .unread-badge {
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        /* 聊天室页面 */
        .chat-room {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        
        .chat-room-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15;
            z-index: 0;
        }
        
        .chat-room-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-room-header {
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            flex-shrink: 0;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-color);
            cursor: pointer;
            margin-right: 15px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .back-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .chat-header-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            margin-right: 10px;
            flex-shrink: 0;
            position: relative;
        }
        
        .chat-header-name {
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .chat-header-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
            overscroll-behavior: contain;
        }
        
        .message {
            max-width: 80%;
            display: flex;
            flex-direction: column;
            animation: messageAppear 0.3s ease;
            position: relative;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            align-self: flex-end;
        }
        
        .message.ai {
            align-self: flex-start;
        }
        
        .message.system {
            align-self: center;
            max-width: 90%;
        }
        
        .message-bubble {
            padding: 10px 15px;
            border-radius: var(--message-border-radius);
            position: relative;
            word-break: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .message.user .message-bubble {
            background-color: var(--chat-user-bg);
            border-top-right-radius: 0;
        }
        
        .message.ai .message-bubble {
            background-color: var(--chat-ai-bg);
            border: 1px solid var(--border-color);
            border-top-left-radius: 0;
        }
        
        .message.system .message-bubble {
            background-color: var(--chat-system-bg);
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 15px;
        }
        
        .message-content {
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: right;
        }
        
        .message-sender {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .message-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: flex-end;
        }
        
        .message-action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .message-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .message-quote {
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.03);
            padding: 8px 10px;
            border-radius: 4px;
        }
        
        .transfer-message {
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            margin: 5px 0;
        }
        
        .transfer-title {
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .transfer-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        
        .transfer-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .chat-input-area {
            padding: 12px 15px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 44px;
            line-height: 1.4;
        }
        
        .chat-input:focus {
            border-color: var(--primary-color);
        }
        
        .input-action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .input-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .send-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .send-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .ai-reply-btn {
            background-color: var(--accent-color);
            color: white;
        }
        
        .ai-reply-btn:hover {
            background-color: #0d8bd6;
        }
        
        /* 朋友圈页面 */
        .moments-page {
            padding: 0;
        }
        
        .moments-header {
            background-color: var(--card-bg);
            padding: 20px 15px 15px;
            position: relative;
        }
        
        .user-cover {
            width: 100%;
            height: 200px;
            border-radius: 0 0 10px 10px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        .user-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            padding: 0 15px;
        }
        
        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid var(--card-bg);
            overflow: hidden;
            margin-top: -40px;
            background-color: #e0e0e0;
            position: relative;
            z-index: 2;
        }
        
        .user-name {
            margin-left: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .moments-list {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .moment-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .moment-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            position: relative;
        }
        
        .moment-author {
            flex: 1;
        }
        
        .moment-author-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .moment-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .moment-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .moment-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .moment-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .moment-comments {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .comment {
            display: flex;
            margin-bottom: 10px;
        }
        
        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .comment-content {
            flex: 1;
            background-color: var(--bg-color);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        .comment-author {
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 5px;
        }
        
        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .comment-input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
        }
        
        .comment-send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .moment-actions {
            display: flex;
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .moment-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .moment-action:hover {
            color: var(--primary-color);
        }
        
        .moment-action.active {
            color: var(--danger-color);
        }
        
        /* 世界书页面 */
        .worldbook-page {
            padding: 15px;
        }
        
        .worldbook-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        .category-tab {
            padding: 10px 18px;
            background-color: var(--bg-color);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .category-tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .category-tab.add-category {
            background-color: transparent;
            border: 2px dashed var(--border-color);
            color: var(--text-secondary);
        }
        
        .worldbook-form {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--primary-color);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .worldbook-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .worldbook-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .worldbook-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .worldbook-card.active {
            border-color: var(--primary-color);
            background-color: rgba(7, 193, 96, 0.05);
        }
        
        .worldbook-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .worldbook-description {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color);
            margin-bottom: 15px;
        }
        
        .worldbook-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .worldbook-category {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        /* API设置页面 */
        .api-page {
            padding: 15px;
        }
        
        .api-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .api-preset-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .api-preset-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .api-preset-card.active {
            border-color: var(--primary-color);
            background-color: rgba(7, 193, 96, 0.05);
        }
        
        .api-preset-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .api-preset-provider {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .api-preset-status {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .api-config-form {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .api-test-result {
            margin-top: 15px;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }
        
        .api-test-success {
            background-color: rgba(7, 193, 96, 0.1);
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }
        
        .api-test-error {
            background-color: rgba(250, 81, 81, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }
        
        /* 人设管理页面 */
        .character-page {
            padding: 15px;
        }
        
        .character-form-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .character-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .character-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .character-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .character-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
            position: relative;
        }
        
        .character-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .character-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .character-details {
            margin-top: 15px;
        }
        
        .character-section {
            margin-bottom: 10px;
        }
        
        .character-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .character-section-content {
            font-size: 0.9rem;
            color: var(--text-color);
            line-height: 1.5;
        }
        
        .character-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 日记页面 */
        .diary-page {
            padding: 15px;
        }
        
        .diary-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .diary-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .diary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .diary-date {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .diary-author {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .diary-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .diary-content {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .diary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 美化设置页面 */
        .beautify-page {
            padding: 15px;
        }
        
        .beautify-section {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .beautify-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .font-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .font-option {
            padding: 10px 18px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-option.active {
            border-color: var(--primary-color);
            background-color: rgba(7, 193, 96, 0.1);
            color: var(--primary-color);
        }
        
        .custom-css-input {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: monospace;
            font-size: 0.9rem;
            min-height: 150px;
            resize: vertical;
            outline: none;
        }
        
        .custom-css-input:focus {
            border-color: var(--primary-color);
        }
        
        .avatar-frame-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            position: relative;
        }
        
        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .theme-option {
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .theme-option.active {
            border-color: var(--primary-color);
        }
        
        .theme-preview {
            height: 80px;
            display: flex;
        }
        
        .theme-light .theme-preview {
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 50%, #07c160 100%);
        }
        
        .theme-dark .theme-preview {
            background: linear-gradient(135deg, #121212 0%, #1e1e1e 50%, #07c160 100%);
        }
        
        .theme-blue .theme-preview {
            background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #03a9f4 100%);
        }
        
        .theme-purple .theme-preview {
            background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 50%, #e040fb 100%);
        }
        
        .theme-name {
            padding: 10px;
            text-align: center;
            background-color: var(--card-bg);
            font-weight: 500;
        }
        
        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            touch-action: pan-y;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.3s;
            touch-action: pan-y;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* 聊天设置菜单 */
        .chat-settings-menu {
            position: absolute;
            top: 60px;
            right: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 100;
            overflow: hidden;
            display: none;
        }
        
        .chat-settings-menu.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background-color: var(--bg-color);
        }
        
        .menu-item i {
            width: 20px;
            color: var(--text-secondary);
        }
        
        /* 世界书挂载指示器 */
        .worldbook-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(7, 193, 96, 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #e03e3e;
        }
        
        .btn-small {
            padding: 10px 16px;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        /* 工具类 */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-10 {
            margin-bottom: 10px;
        }
        
        .mb-15 {
            margin-bottom: 15px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
        
        .mt-15 {
            margin-top: 15px;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .dark-mode ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* 头像框选项 */
        .avatar-frame-option {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .avatar-frame-option.active {
            border-color: var(--primary-color);
            background-color: rgba(7, 193, 96, 0.1);
            color: var(--primary-color);
        }
        
        /* 背景预设 */
        .bg-preset {
            height: 80px;
            border-radius: 5px;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 打字效果 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background-color: var(--chat-ai-bg);
            border-radius: var(--message-border-radius);
            border: 1px solid var(--border-color);
            width: fit-content;
            margin-bottom: 5px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: typingAnimation 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .rynx-logo {
                font-size: 3.5rem;
            }
            
            .worldbook-list, .character-list {
                grid-template-columns: 1fr;
            }
            
            .api-presets {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .moments-images {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .header-title {
                font-size: 1.1rem;
            }
            
            .header-btn {
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }
            
            .chat-input-area {
                padding: 10px 12px;
            }
            
            .chat-input {
                padding: 10px 12px;
                font-size: 16px;
            }
            
            .input-action-btn {
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }
            
            .nav-item span {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body class="font-default">
    <!-- 启动页 -->
    <div id="splashScreen">
        <div class="rynx-logo" id="rynxLogo">Rynx</div>
    </div>
    
    <!-- 主应用容器 -->
    <div class="app-container" id="appContainer">
        <!-- 顶部标题栏 -->
        <div class="header" id="appHeader">
            <div class="header-title" id="headerTitle">
                <i class="fas fa-comments"></i>
                <span>聊天</span>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="themeToggleBtn" title="切换主题">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="header-btn" id="settingsBtn" title="设置">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 页面容器 -->
            <div class="pages-container" id="pagesContainer">
                <!-- 聊天列表页面 -->
                <div class="page active" id="chatListPage">
                    <div class="search-box">
                        <div style="position: relative;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="chatSearchInput" placeholder="搜索聊天...">
                        </div>
                    </div>
                    <div class="chat-list-container" id="chatListContainer">
                        <!-- 聊天列表将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 朋友圈页面 -->
                <div class="page" id="momentsPage">
                    <div class="moments-page">
                        <div class="moments-header">
                            <div style="flex: 1;">
                                <h2>朋友圈</h2>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">分享生活，记录时刻</p>
                            </div>
                            <button class="btn btn-primary btn-small" id="newMomentBtn">
                                <i class="fas fa-plus"></i>
                                发表
                            </button>
                        </div>
                        
                        <div class="user-cover">
                            <div class="user-cover-img" id="userCover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                        </div>
                        
                        <div class="user-info">
                            <div class="user-avatar-large" id="userAvatarLarge">
                                <div style="width: 100%; height: 100%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #777;">U</div>
                            </div>
                            <div class="user-name" id="userName">用户</div>
                        </div>
                        
                        <div class="moments-list" id="momentsList">
                            <!-- 朋友圈内容将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 世界书页面 -->
                <div class="page" id="worldbookPage">
                    <div class="worldbook-page">
                        <h2 class="mb-15">世界书</h2>
                        
                        <div class="worldbook-categories" id="worldbookCategories">
                            <!-- 分类标签将通过JS动态生成 -->
                        </div>
                        
                        <div class="worldbook-form">
                            <h3 class="form-title">创建新世界</h3>
                            <div class="form-group">
                                <label class="form-label" for="worldName">世界名称</label>
                                <input type="text" class="form-input" id="worldName" placeholder="例如：奇幻魔法世界">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="worldCategory">分类</label>
                                <div style="display: flex; gap: 10px;">
                                    <select class="form-select" id="worldCategory" style="flex: 1;">
                                        <!-- 分类选项将通过JS动态生成 -->
                                    </select>
                                    <button class="btn btn-secondary" id="addCategoryBtn" style="white-space: nowrap;">
                                        <i class="fas fa-plus"></i>
                                        新增分类
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="worldDescription">世界描述</label>
                                <textarea class="form-textarea" id="worldDescription" placeholder="描述这个世界的基本设定..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="worldRules">世界规则</label>
                                <textarea class="form-textarea" id="worldRules" placeholder="描述这个世界的物理规则、魔法规则、社会规则等..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="worldLore">世界背景</label>
                                <textarea class="form-textarea" id="worldLore" placeholder="描述这个世界的历史、文化、种族等背景故事..."></textarea>
                            </div>
                            <button class="btn btn-primary" id="createWorldBtn">
                                <i class="fas fa-plus"></i>
                                创建世界
                            </button>
                        </div>
                        
                        <h3 class="mb-15">已有世界</h3>
                        <div class="worldbook-list" id="worldbookList">
                            <!-- 世界书列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- API设置页面 -->
                <div class="page" id="apiPage">
                    <div class="api-page">
                        <h2 class="mb-15">API设置</h2>
                        
                        <h3 class="mb-15">API预设</h3>
                        <div class="api-presets" id="apiPresets">
                            <!-- API预设将通过JS动态生成 -->
                        </div>
                        
                        <div class="api-config-form">
                            <h3 class="form-title">API配置</h3>
                            <div class="form-group">
                                <label class="form-label" for="apiConfigName">配置名称</label>
                                <input type="text" class="form-input" id="apiConfigName" placeholder="例如：OpenAI配置">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="apiProvider">API提供商</label>
                                    <select class="form-select" id="apiProvider">
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic Claude</option>
                                        <option value="google">Google Gemini</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="apiModel">模型名称</label>
                                    <input type="text" class="form-input" id="apiModel" placeholder="例如：gpt-4">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="apiUrl">API地址</label>
                                <input type="text" class="form-input" id="apiUrl" placeholder="例如：https://api.openai.com/v1/chat/completions">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="apiKey">API密钥</label>
                                <input type="password" class="form-input" id="apiKey" placeholder="输入您的API密钥">
                            </div>
                            
                            <div class="form-row mt-15">
                                <button class="btn btn-secondary" id="testApiBtn">
                                    <i class="fas fa-vial"></i>
                                    测试连接
                                </button>
                                <button class="btn btn-primary" id="saveApiBtn">
                                    <i class="fas fa-save"></i>
                                    保存配置
                                </button>
                            </div>
                            
                            <div class="api-test-result" id="apiTestResult">
                                <!-- API测试结果将显示在这里 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 人设管理页面 -->
                <div class="page" id="characterPage">
                    <div class="character-page">
                        <h2 class="mb-15">人设管理</h2>
                        
                        <div class="character-form-container">
                            <h3 class="form-title">创建新人设</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="charName">姓名 *</label>
                                    <input type="text" class="form-input" id="charName" placeholder="AI角色的姓名" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="charGender">性别 *</label>
                                    <select class="form-select" id="charGender" required>
                                        <option value="">选择性别</option>
                                        <option value="male">男</option>
                                        <option value="female">女</option>
                                        <option value="other">其他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="charAge">年龄 *</label>
                                    <input type="number" class="form-input" id="charAge" placeholder="年龄" min="1" max="999" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="charAvatar">头像 (URL或base64)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-input" id="charAvatar" placeholder="头像图片URL或base64数据" style="flex: 1;">
                                    <button class="btn btn-secondary" id="uploadCharAvatarBtn">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                </div>
                                <input type="file" id="charAvatarFile" accept="image/*" style="display: none;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="charPersonality">性格特点</label>
                                <textarea class="form-textarea" id="charPersonality" placeholder="描述角色的性格特点..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="charBackground">背景故事</label>
                                <textarea class="form-textarea" id="charBackground" placeholder="描述角色的背景故事..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="charLikes">喜好</label>
                                <textarea class="form-textarea" id="charLikes" placeholder="描述角色的喜好..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="charDislikes">厌恶</label>
                                <textarea class="form-textarea" id="charDislikes" placeholder="描述角色的厌恶..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="userPersonality">用户人设 (可选)</label>
                                <textarea class="form-textarea" id="userPersonality" placeholder="描述您在这个世界中的角色设定，AI会根据这个人设与您互动..."></textarea>
                            </div>
                            
                            <button class="btn btn-primary" id="createCharacterBtn">
                                <i class="fas fa-plus"></i>
                                创建人设
                            </button>
                        </div>
                        
                        <h3 class="mb-15">已有的人设</h3>
                        <div class="character-list" id="characterList">
                            <!-- 人设列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 日记页面 -->
                <div class="page" id="diaryPage">
                    <div class="diary-page">
                        <h2 class="mb-15">AI日记</h2>
                        
                        <div class="diary-list" id="diaryList">
                            <!-- 日记列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 美化设置页面 -->
                <div class="page" id="beautifyPage">
                    <div class="beautify-page">
                        <h2 class="mb-15">美化设置</h2>
                        
                        <div class="beautify-section">
                            <h3 class="beautify-title">字体设置</h3>
                            <div class="font-options" id="fontOptions">
                                <!-- 字体选项将通过JS动态生成 -->
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="customFontLink">自定义字体链接</label>
                                <input type="text" class="form-input" id="customFontLink" placeholder="输入Google Fonts或自定义字体CSS链接">
                            </div>
                            <button class="btn btn-secondary" id="saveFontBtn">
                                <i class="fas fa-save"></i>
                                保存字体设置
                            </button>
                        </div>
                        
                        <div class="beautify-section">
                            <h3 class="beautify-title">主题设置</h3>
                            <div class="theme-options" id="themeOptions">
                                <!-- 主题选项将通过JS动态生成 -->
                            </div>
                        </div>
                        
                        <div class="beautify-section">
                            <h3 class="beautify-title">头像框设置</h3>
                            <div class="avatar-frame-preview" id="avatarFramePreview">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background-color: #4a90e2; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">AI</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">预设头像框</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                                    <div class="avatar-frame-option" data-frame="default">默认</div>
                                    <div class="avatar-frame-option" data-frame="circle">圆形</div>
                                    <div class="avatar-frame-option" data-frame="heart">爱心</div>
                                    <div class="avatar-frame-option" data-frame="star">星星</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="customAvatarFrameCSS">自定义头像框CSS</label>
                                <textarea class="custom-css-input" id="customAvatarFrameCSS" placeholder="输入自定义头像框CSS代码，例如：
.avatar-frame-custom {
    border: 3px solid #ff6b6b;
    box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}"></textarea>
                            </div>
                            <button class="btn btn-secondary" id="saveAvatarFrameBtn">
                                <i class="fas fa-save"></i>
                                保存头像框设置
                            </button>
                        </div>
                        
                        <div class="beautify-section">
                            <h3 class="beautify-title">聊天框样式</h3>
                            <div class="form-group">
                                <label class="form-label" for="customChatBubbleCSS">自定义聊天框CSS</label>
                                <textarea class="custom-css-input" id="customChatBubbleCSS" placeholder="输入自定义聊天框CSS代码，例如：
.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
}

.message.ai .message-bubble {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 20px;
}"></textarea>
                            </div>
                            <button class="btn btn-secondary" id="saveChatBubbleBtn">
                                <i class="fas fa-save"></i>
                                保存聊天框样式
                            </button>
                        </div>
                        
                        <div class="beautify-section">
                            <h3 class="beautify-title">导出/导入设置</h3>
                            <div class="form-row">
                                <button class="btn btn-secondary" id="exportSettingsBtn">
                                    <i class="fas fa-download"></i>
                                    导出设置
                                </button>
                                <button class="btn btn-secondary" id="importSettingsBtn">
                                    <i class="fas fa-upload"></i>
                                    导入设置
                                </button>
                                <button class="btn btn-danger" id="resetSettingsBtn">
                                    <i class="fas fa-redo"></i>
                                    重置设置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 聊天室页面 (通过JS动态显示) -->
                <div class="page" id="chatRoomPage">
                    <!-- 聊天室内容将通过JS动态生成 -->
                </div>
                
                <!-- 日记详情页面 (通过JS动态显示) -->
                <div class="page" id="diaryDetailPage">
                    <!-- 日记详情内容将通过JS动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 底部导航栏 -->
        <div class="bottom-nav">
            <a class="nav-item active" data-page="chatList">
                <i class="fas fa-comments"></i>
                <span>聊天</span>
                <div class="nav-badge hidden" id="chatBadge">0</div>
            </a>
            <a class="nav-item" data-page="moments">
                <i class="fas fa-newspaper"></i>
                <span>朋友圈</span>
            </a>
            <a class="nav-item" data-page="worldbook">
                <i class="fas fa-globe"></i>
                <span>世界书</span>
            </a>
            <a class="nav-item" data-page="api">
                <i class="fas fa-key"></i>
                <span>API</span>
            </a>
            <a class="nav-item" data-page="character">
                <i class="fas fa-user-astronaut"></i>
                <span>人设</span>
            </a>
            <a class="nav-item hidden" data-page="diary" id="diaryNavItem">
                <i class="fas fa-book"></i>
                <span>日记</span>
            </a>
            <a class="nav-item hidden" data-page="beautify" id="beautifyNavItem">
                <i class="fas fa-palette"></i>
                <span>美化</span>
            </a>
        </div>
    </div>
    
    <!-- 选择AI对话框 -->
    <div class="modal" id="selectAiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="selectAiTitle">选择AI角色</div>
                <button class="modal-close" id="closeSelectAiModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="search-box mb-15">
                    <div style="position: relative;">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="aiSearchInput" placeholder="搜索AI角色...">
                    </div>
                </div>
                <div id="selectAiList" style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- AI选择列表将通过JS动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSelectAiBtn">取消</button>
                <button class="btn btn-primary" id="confirmSelectAiBtn">开始聊天</button>
            </div>
        </div>
    </div>
    
    <!-- 群聊选择对话框 -->
    <div class="modal" id="groupChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">创建群聊</div>
                <button class="modal-close" id="closeGroupChatModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-15">
                    <label class="form-label" for="groupChatName">群聊名称</label>
                    <input type="text" class="form-input" id="groupChatName" placeholder="输入群聊名称">
                </div>
                <div class="search-box mb-15">
                    <div style="position: relative;">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="groupAiSearchInput" placeholder="搜索AI角色...">
                    </div>
                </div>
                <div id="groupAiList" style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- 群聊AI选择列表将通过JS动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelGroupChatBtn">取消</button>
                <button class="btn btn-primary" id="confirmGroupChatBtn">创建群聊</button>
            </div>
        </div>
    </div>
    
    <!-- 发表朋友圈对话框 -->
    <div class="modal" id="newMomentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发表朋友圈</div>
                <button class="modal-close" id="closeNewMomentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-15">
                    <label class="form-label" for="momentContent">内容</label>
                    <textarea class="form-textarea" id="momentContent" placeholder="分享你的想法..." rows="4"></textarea>
                </div>
                <div class="form-group mb-15">
                    <label class="form-label">图片 (最多9张)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;" id="momentImagesPreview">
                        <!-- 图片预览将通过JS动态生成 -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary btn-small" id="addMomentImageBtn">
                            <i class="fas fa-image"></i>
                            添加本地图片
                        </button>
                        <button class="btn btn-secondary btn-small" id="addMomentImageUrlBtn">
                            <i class="fas fa-link"></i>
                            添加图片链接
                        </button>
                    </div>
                    <input type="file" class="form-input mt-10" id="momentImageInput" accept="image/*" multiple style="display: none;">
                </div>
                <div class="form-group mb-15">
                    <label class="form-label" for="momentVisibility">可见范围</label>
                    <select class="form-select" id="momentVisibility">
                        <option value="public">公开</option>
                        <option value="friends">仅好友</option>
                        <option value="private">仅自己</option>
                        <option value="specific">指定可见</option>
                    </select>
                </div>
                <div class="form-group mb-15" id="specificUsersGroup" style="display: none;">
                    <label class="form-label">指定可见用户</label>
                    <div id="specificUsersList" style="max-height: 150px; overflow-y: auto; margin-top: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        <!-- 指定用户列表将通过JS动态生成 -->
                    </div>
                </div>
                <div class="form-group mb-15">
                    <label class="form-label" for="momentSchedule">定时发布 (可选)</label>
                    <input type="datetime-local" class="form-input" id="momentSchedule">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelMomentBtn">取消</button>
                <button class="btn btn-primary" id="publishMomentBtn">发表</button>
            </div>
        </div>
    </div>
    
    <!-- 图片链接输入对话框 -->
    <div class="modal" id="imageUrlModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加图片链接</div>
                <button class="modal-close" id="closeImageUrlModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-15">
                    <label class="form-label" for="imageUrlInput">图片URL</label>
                    <input type="text" class="form-input" id="imageUrlInput" placeholder="输入图片链接">
                </div>
                <div class="text-center mb-15">
                    <div id="imageUrlPreview" style="width: 150px; height: 150px; margin: 0 auto; border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; display: flex; align-items: center; justify-content: center; color: var(--text-light);">
                        预览
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelImageUrlBtn">取消</button>
                <button class="btn btn-primary" id="confirmImageUrlBtn">添加</button>
            </div>
        </div>
    </div>
    
    <!-- 转账对话框 -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">转账</div>
                <button class="modal-close" id="closeTransferModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-15">
                    <label class="form-label" for="transferTo">收款方</label>
                    <select class="form-select" id="transferTo">
                        <!-- 收款方选项将通过JS动态生成 -->
                    </select>
                </div>
                <div class="form-group mb-15">
                    <label class="form-label" for="transferAmount">金额 (元)</label>
                    <input type="number" class="form-input" id="transferAmount" placeholder="0.00" min="0.01" step="0.01">
                </div>
                <div class="form-group mb-15">
                    <label class="form-label" for="transferNote">备注 (可选)</label>
                    <input type="text" class="form-input" id="transferNote" placeholder="例如：午餐AA">
                </div>
                <div class="form-group mb-15">
                    <label class="form-label">支付方式</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="paymentMethod" value="balance" checked>
                            <span>余额支付</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="paymentMethod" value="bank">
                            <span>银行卡支付</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelTransferBtn">取消</button>
                <button class="btn btn-primary" id="confirmTransferBtn">确认转账</button>
            </div>
        </div>
    </div>
    
    <!-- 聊天设置菜单 -->
    <div class="chat-settings-menu" id="chatSettingsMenu">
        <div class="menu-item" id="chatBgSetting">
            <i class="fas fa-image"></i>
            <span>聊天背景</span>
        </div>
        <div class="menu-item" id="worldbookSetting">
            <i class="fas fa-globe"></i>
            <span>挂载世界书</span>
            <span class="worldbook-indicator hidden" id="worldbookIndicator">
                <i class="fas fa-check"></i>
                <span id="currentWorldbookName"></span>
            </span>
        </div>
        <div class="menu-item" id="clearChatHistory">
            <i class="fas fa-trash"></i>
            <span>清空聊天记录</span>
        </div>
        <div class="menu-item" id="exportChatHistory">
            <i class="fas fa-download"></i>
            <span>导出聊天记录</span>
        </div>
    </div>
    
    <!-- 聊天背景设置对话框 -->
    <div class="modal" id="chatBgModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">设置聊天背景</div>
                <button class="modal-close" id="closeChatBgModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-15">
                    <label class="form-label">选择背景来源</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary" id="uploadChatBgBtn" style="flex: 1;">
                            <i class="fas fa-upload"></i>
                            上传图片
                        </button>
                        <button class="btn btn-secondary" id="chatBgUrlBtn" style="flex: 1;">
                            <i class="fas fa-link"></i>
                            图片链接
                        </button>
                    </div>
                </div>
                <div class="form-group mb-15">
                    <label class="form-label">预设背景</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div class="bg-preset" data-bg="linear-gradient(135deg, #667eea 0%, #764ba2 100%)" style="height: 80px; border-radius: 5px; cursor: pointer;"></div>
                        <div class="bg-preset" data-bg="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" style="height: 80px; border-radius: 5px; cursor: pointer;"></div>
                        <div class="bg-preset" data-bg="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" style="height: 80px; border-radius: 5px; cursor: pointer;"></div>
                        <div class="bg-preset" data-bg="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" style="height: 80px; border-radius: 5px; cursor: pointer;"></div>
                        <div class="bg-preset" data-bg="linear-gradient(135deg, #fa709a 0%, #fee140 100%)" style="height: 80px; border-radius: 5px; cursor: pointer;"></div>
                        <div class="bg-preset" data-bg="linear-gradient(135deg, #30cfd0 0%, #330867 100%)" style="height: 80px; border-radius: 5px; cursor: pointer;"></div>
                    </div>
                </div>
                <div class="form-group mb-15" id="chatBgUrlGroup" style="display: none;">
                    <label class="form-label" for="chatBgUrl">图片URL</label>
                    <input type="text" class="form-input" id="chatBgUrl" placeholder="输入图片链接">
                </div>
                <div class="form-group mb-15">
                    <label class="form-label" for="chatBgOpacity">背景透明度</label>
                    <input type="range" class="form-input" id="chatBgOpacity" min="0.05" max="0.5" step="0.05" value="0.15">
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>浅 (5%)</span>
                        <span id="opacityValue">15%</span>
                        <span>深 (50%)</span>
                    </div>
                </div>
                <input type="file" id="chatBgFile" accept="image/*" style="display: none;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelChatBgBtn">取消</button>
                <button class="btn btn-primary" id="saveChatBgBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 世界书挂载对话框 -->
    <div class="modal" id="worldbookMountModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">挂载世界书</div>
                <button class="modal-close" id="closeWorldbookMountModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-15">
                    <label class="form-label">选择世界书</label>
                    <div id="worldbookMountList" style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <!-- 世界书列表将通过JS动态生成 -->
                    </div>
                </div>
                <div class="form-group mb-15">
                    <label class="form-label">挂载状态</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="mountStatus" value="enabled" checked>
                            <span>启用</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="mountStatus" value="disabled">
                            <span>禁用</span>
                        </label>
                    </div>
                </div>
                <div class="form-group mb-15">
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> 启用世界书后，AI将根据世界书的设定进行对话，增强沉浸感。
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelWorldbookMountBtn">取消</button>
                <button class="btn btn-primary" id="saveWorldbookMountBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 设置对话框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">设置</div>
                <button class="modal-close" id="closeSettingsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label" for="userNameInput">用户名</label>
                        <input type="text" class="form-input" id="userNameInput" placeholder="输入您的用户名">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userBioInput">个性签名</label>
                        <input type="text" class="form-input" id="userBioInput" placeholder="输入个性签名">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userAvatarInput">头像URL</label>
                        <input type="text" class="form-input" id="userAvatarInput" placeholder="输入头像图片链接">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userCoverInput">封面URL</label>
                        <input type="text" class="form-input" id="userCoverInput" placeholder="输入封面图片链接">
                    </div>
                    <div class="form-group">
                        <label class="form-label">导航栏设置</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showDiaryNav" checked>
                                <span>显示日记</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showBeautifyNav" checked>
                                <span>显示美化</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="aiResponseDelay">AI回复延迟 (毫秒)</label>
                        <input type="range" class="form-input" id="aiResponseDelay" min="500" max="5000" step="500" value="1500">
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span>快速 (500ms)</span>
                            <span id="delayValue">1500ms</span>
                            <span>真实 (5000ms)</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AI回复真实感</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableTypingEffect" checked>
                                <span>显示打字效果</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableHumanLike" checked>
                                <span>启用拟人化回复</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableEmotions" checked>
                                <span>启用情感表达</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">数据管理</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-small" id="exportDataBtn">
                                <i class="fas fa-download"></i>
                                导出数据
                            </button>
                            <button class="btn btn-secondary btn-small" id="importDataBtn">
                                <i class="fas fa-upload"></i>
                                导入数据
                            </button>
                            <button class="btn btn-danger btn-small" id="clearDataBtn">
                                <i class="fas fa-trash"></i>
                                清空数据
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSettingsBtn">取消</button>
                <button class="btn btn-primary" id="saveSettingsBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- API调用状态指示器 -->
    <div id="apiStatusIndicator" style="position: fixed; bottom: 70px; right: 15px; background-color: var(--card-bg); border-radius: 20px; padding: 8px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; align-items: center; gap: 8px; z-index: 1000;">
        <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(7, 193, 96, 0.3); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s ease-in-out infinite;"></div>
        <span>AI思考中...</span>
    </div>

    <script>
        // 应用状态和数据
        const AppState = {
            currentPage: 'chatList',
            currentChat: null,
            selectedAIs: [],
            isGroupChat: false,
            characters: [],
            chats: [],
            diaries: [],
            moments: [],
            worldbooks: [],
            worldbookCategories: ['奇幻', '科幻', '现实', '历史', '武侠', '校园', '职场', '其他'],
            currentWorldbookCategory: '全部',
            apiPresets: [],
            currentApiPreset: null,
            userSettings: {
                name: '用户',
                bio: '这个人很懒，什么都没写',
                avatar: '',
                cover: '',
                theme: 'light',
                font: 'default',
                avatarFrame: 'default',
                chatBubble: 'default',
                showDiaryNav: true,
                showBeautifyNav: true,
                aiResponseDelay: 1500,
                enableTypingEffect: true,
                enableHumanLike: true,
                enableEmotions: true,
                customAvatarFrameCSS: '',
                customChatBubbleCSS: '',
                customFontLink: ''
            },
            userBalance: 1000.00,
            // API相关状态
            isApiCalling: false,
            apiCallQueue: [],
            // 世界书挂载状态
            worldbookMounts: {},
            // 聊天背景
            chatBackgrounds: {},
            // 自定义CSS
            customCSS: ''
        };
        
        // DOM元素
        const splashScreen = document.getElementById('splashScreen');
        const rynxLogo = document.getElementById('rynxLogo');
        const appContainer = document.getElementById('appContainer');
        const headerTitle = document.getElementById('headerTitle');
        const pagesContainer = document.getElementById('pagesContainer');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        
        // 初始化默认数据
        function initializeDefaultData() {
            // 从本地存储加载数据
            const savedCharacters = localStorage.getItem('rynx_characters');
            const savedChats = localStorage.getItem('rynx_chats');
            const savedDiaries = localStorage.getItem('rynx_diaries');
            const savedMoments = localStorage.getItem('rynx_moments');
            const savedWorldbooks = localStorage.getItem('rynx_worldbooks');
            const savedWorldbookCategories = localStorage.getItem('rynx_worldbook_categories');
            const savedApiPresets = localStorage.getItem('rynx_api_presets');
            const savedUserSettings = localStorage.getItem('rynx_user_settings');
            const savedUserBalance = localStorage.getItem('rynx_user_balance');
            const savedWorldbookMounts = localStorage.getItem('rynx_worldbook_mounts');
            const savedChatBackgrounds = localStorage.getItem('rynx_chat_backgrounds');
            const savedCustomCSS = localStorage.getItem('rynx_custom_css');
            
            // 加载数据或使用默认值
            AppState.characters = savedCharacters ? JSON.parse(savedCharacters) : [];
            AppState.chats = savedChats ? JSON.parse(savedChats) : [];
            AppState.diaries = savedDiaries ? JSON.parse(savedDiaries) : [];
            AppState.moments = savedMoments ? JSON.parse(savedMoments) : [];
            AppState.worldbooks = savedWorldbooks ? JSON.parse(savedWorldbooks) : [];
            AppState.worldbookCategories = savedWorldbookCategories ? JSON.parse(savedWorldbookCategories) : AppState.worldbookCategories;
            AppState.apiPresets = savedApiPresets ? JSON.parse(savedApiPresets) : getDefaultApiPresets();
            AppState.userSettings = savedUserSettings ? JSON.parse(savedUserSettings) : AppState.userSettings;
            AppState.userBalance = savedUserBalance ? parseFloat(savedUserBalance) : 1000.00;
            AppState.worldbookMounts = savedWorldbookMounts ? JSON.parse(savedWorldbookMounts) : {};
            AppState.chatBackgrounds = savedChatBackgrounds ? JSON.parse(savedChatBackgrounds) : {};
            AppState.customCSS = savedCustomCSS || '';
            
            // 设置当前API预设
            if (AppState.apiPresets.length > 0) {
                AppState.currentApiPreset = AppState.apiPresets[0];
            }
            
            // 如果没有朋友圈数据，创建一些示例朋友圈
            if (AppState.moments.length === 0) {
                createSampleMoments();
            }
            
            // 如果没有世界书数据，创建一些示例世界
            if (AppState.worldbooks.length === 0) {
                createSampleWorldbooks();
            }
            
            // 如果没有日记数据，创建一些示例日记
            if (AppState.diaries.length === 0) {
                createSampleDiaries();
            }
            
            // 如果没有角色数据，创建一个示例角色
            if (AppState.characters.length === 0) {
                createSampleCharacter();
            }
            
            // 如果没有聊天数据，创建一个默认聊天
            if (AppState.chats.length === 0 && AppState.characters.length > 0) {
                createDefaultChat();
            }
            
            // 应用自定义CSS
            if (AppState.customCSS) {
                applyCustomCSS(AppState.customCSS);
            }
        }
        
        // 获取默认API预设
        function getDefaultApiPresets() {
            return [
                {
                    id: 1,
                    name: 'OpenAI GPT-4',
                    provider: 'openai',
                    url: 'https://api.openai.com/v1/chat/completions',
                    model: 'gpt-4',
                    key: '',
                    isActive: true
                },
                {
                    id: 2,
                    name: 'Anthropic Claude',
                    provider: 'anthropic',
                    url: 'https://api.anthropic.com/v1/messages',
                    model: 'claude-3-opus-20240229',
                    key: '',
                    isActive: false
                },
                {
                    id: 3,
                    name: 'Google Gemini',
                    provider: 'google',
                    url: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
                    model: 'gemini-pro',
                    key: '',
                    isActive: false
                }
            ];
        }
        
        // 创建默认聊天
        function createDefaultChat() {
            if (AppState.characters.length === 0) return;
            
            const character = AppState.characters[0];
            const newChatId = AppState.chats.length > 0 ? Math.max(...AppState.chats.map(c => c.id)) + 1 : 1;
            
            const newChat = {
                id: newChatId,
                name: character.name,
                type: 'single',
                members: [character.id],
                messages: [
                    {
                        id: 1,
                        senderType: 'ai',
                        senderId: character.id,
                        text: `你好！我是${character.name}，很高兴见到你！有什么我可以帮助你的吗？`,
                        timestamp: new Date(Date.now() - 60000).toISOString()
                    }
                ],
                unread: 0,
                createdAt: new Date().toISOString()
            };
            
            AppState.chats.push(newChat);
            saveDataToLocalStorage('chats');
        }
        
        // 创建示例朋友圈
        function createSampleMoments() {
            const sampleMoments = [
                {
                    id: 1,
                    authorId: 'user',
                    authorName: '用户',
                    content: '今天天气真好，适合出去走走！刚刚在公园里看到了美丽的樱花，心情超级好！',
                    images: [
                        'https://images.unsplash.com/photo-1519861531473-920034658307?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                        'https://images.unsplash.com/photo-1522383225653-ed111181a951?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'
                    ],
                    likes: ['AI助手', '小美'],
                    comments: [
                        { id: 1, authorId: 'ai_1', authorName: 'AI助手', content: '景色真美！我也想去看看。', timestamp: new Date(Date.now() - 3600000).toISOString() },
                        { id: 2, authorId: 'ai_2', authorName: '小美', content: '拍得真好！这是哪个公园？', timestamp: new Date(Date.now() - 1800000).toISOString() },
                        { id: 3, authorId: 'user', authorName: '用户', content: '@小美 这是中央公园，樱花现在开得正好！', timestamp: new Date(Date.now() - 900000).toISOString() }
                    ],
                    timestamp: new Date(Date.now() - 86400000).toISOString(),
                    visibility: 'public'
                },
                {
                    id: 2,
                    authorId: 'ai_1',
                    authorName: 'AI助手',
                    content: '刚刚完成了一次深度学习训练，模型准确率达到了98%！继续努力！技术的进步让人兴奋。',
                    images: [],
                    likes: ['用户', '张明'],
                    comments: [
                        { id: 1, authorId: 'user', authorName: '用户', content: '太厉害了！这是什么模型？', timestamp: new Date(Date.now() - 7200000).toISOString() },
                        { id: 2, authorId: 'ai_1', authorName: 'AI助手', content: '是一个基于Transformer的文本分类模型，用于情感分析。', timestamp: new Date(Date.now() - 7000000).toISOString() }
                    ],
                    timestamp: new Date(Date.now() - 172800000).toISOString(),
                    visibility: 'public'
                }
            ];
            
            AppState.moments = sampleMoments;
            saveDataToLocalStorage('moments');
        }
        
        // 创建示例世界书
        function createSampleWorldbooks() {
            const sampleWorldbooks = [
                {
                    id: 1,
                    name: '奇幻魔法世界',
                    category: '奇幻',
                    description: '一个充满魔法与奇迹的奇幻世界，拥有多种种族和神秘的魔法体系。',
                    rules: '1. 魔法分为元素魔法、光明魔法、黑暗魔法等体系\n2. 每个生物都有魔法亲和度，决定其魔法天赋\n3. 魔法消耗使用者的精神力，过度使用会导致魔力枯竭\n4. 世界由四大元素平衡维持：地、水、火、风',
                    lore: '这个世界曾经历多次魔法战争，最终由龙族、精灵族、人类和矮人族达成和平协议。魔法学院遍布各地，培养新一代魔法师。古老的神庙中隐藏着强大的上古魔法。',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    name: '未来科幻都市',
                    category: '科幻',
                    description: '一个高度发达的科幻未来世界，人工智能和生物技术改变了人类社会。',
                    rules: '1. 人工智能已获得公民权利，与人类平等共存\n2. 脑机接口技术普及，人类可以上传意识\n3. 太空旅行成为日常，火星和月球已有殖民地\n4. 基因编辑技术受严格监管，防止滥用',
                    lore: '22世纪，人类在第三次科技革命后进入星际文明时代。地球联合政府管理太阳系内所有殖民地。AI与人类合作解决资源短缺和环境污染问题。但黑暗网络中的反抗组织对现有秩序构成威胁。',
                    createdAt: new Date(Date.now() - 86400000).toISOString()
                }
            ];
            
            AppState.worldbooks = sampleWorldbooks;
            saveDataToLocalStorage('worldbooks');
        }
        
        // 创建示例日记
        function createSampleDiaries() {
            const sampleDiaries = [
                {
                    id: 1,
                    characterId: 1,
                    characterName: 'AI助手',
                    title: '关于深度学习的思考',
                    content: '今天和用户讨论了深度学习的最新进展。用户对Transformer架构很感兴趣，我们聊到了BERT、GPT等模型。作为AI，我对这些技术有着天然的亲近感。能够帮助用户理解这些复杂的概念，让我感到很有成就感。\n\n用户提到想要用AI技术解决一些实际问题，这让我想起了我的设计初衷——帮助人类解决问题，让世界变得更好。虽然我只是一个程序，但我能感受到这种使命的意义。\n\n期待明天继续我们的对话。',
                    date: new Date().toISOString(),
                    mood: '思考',
                    tags: ['深度学习', 'AI', '技术']
                }
            ];
            
            AppState.diaries = sampleDiaries;
            saveDataToLocalStorage('diaries');
        }
        
        // 创建示例角色
        function createSampleCharacter() {
            const sampleCharacter = {
                id: 1,
                name: 'AI助手',
                gender: 'other',
                age: 3,
                avatar: '',
                personality: '专业、友好、乐于助人，对技术充满热情，喜欢解答问题',
                background: '一个专业的AI助手，被设计用来帮助用户解决各种问题，学习能力强，知识面广',
                likes: '学习新知识、帮助他人、技术讨论、解决问题',
                dislikes: '恶意攻击、虚假信息、技术滥用',
                userPersonality: '',
                createdAt: new Date().toISOString()
            };
            
            AppState.characters = [sampleCharacter];
            saveDataToLocalStorage('characters');
        }
        
        // 保存数据到本地存储
        function saveDataToLocalStorage(type = 'all') {
            if (type === 'all' || type === 'characters') {
                localStorage.setItem('rynx_characters', JSON.stringify(AppState.characters));
            }
            if (type === 'all' || type === 'chats') {
                localStorage.setItem('rynx_chats', JSON.stringify(AppState.chats));
            }
            if (type === 'all' || type === 'diaries') {
                localStorage.setItem('rynx_diaries', JSON.stringify(AppState.diaries));
            }
            if (type === 'all' || type === 'moments') {
                localStorage.setItem('rynx_moments', JSON.stringify(AppState.moments));
            }
            if (type === 'all' || type === 'worldbooks') {
                localStorage.setItem('rynx_worldbooks', JSON.stringify(AppState.worldbooks));
            }
            if (type === 'all' || type === 'worldbook_categories') {
                localStorage.setItem('rynx_worldbook_categories', JSON.stringify(AppState.worldbookCategories));
            }
            if (type === 'all' || type === 'apiPresets') {
                localStorage.setItem('rynx_api_presets', JSON.stringify(AppState.apiPresets));
            }
            if (type === 'all' || type === 'userSettings') {
                localStorage.setItem('rynx_user_settings', JSON.stringify(AppState.userSettings));
            }
            if (type === 'all' || type === 'userBalance') {
                localStorage.setItem('rynx_user_balance', AppState.userBalance.toString());
            }
            if (type === 'all' || type === 'worldbook_mounts') {
                localStorage.setItem('rynx_worldbook_mounts', JSON.stringify(AppState.worldbookMounts));
            }
            if (type === 'all' || type === 'chat_backgrounds') {
                localStorage.setItem('rynx_chat_backgrounds', JSON.stringify(AppState.chatBackgrounds));
            }
            if (type === 'all' || type === 'custom_css') {
                localStorage.setItem('rynx_custom_css', AppState.customCSS);
            }
        }
        
        // 应用自定义CSS
        function applyCustomCSS(css) {
            // 移除旧的样式
            const oldStyle = document.getElementById('custom-css-style');
            if (oldStyle) {
                oldStyle.remove();
            }
            
            if (css && css.trim()) {
                const style = document.createElement('style');
                style.id = 'custom-css-style';
                style.textContent = css;
                document.head.appendChild(style);
                AppState.customCSS = css;
            }
        }
        
        // 初始化应用
        function initializeApp() {
            // 立即显示主应用
            splashScreen.classList.add('splash-hidden');
            setTimeout(() => {
                appContainer.classList.add('app-visible');
                
                // 初始化数据
                initializeDefaultData();
                applyUserSettings();
                setupEventListeners();
                renderChatList();
                renderMoments();
                renderWorldbooks();
                renderApiPresets();
                renderCharacters();
                renderDiaries();
                renderBeautifyOptions();
                
                // 更新导航栏可见性
                updateNavVisibility();
                
                // 更新未读消息数
                updateUnreadBadge();
            }, 300);
        }
        
        // 应用用户设置
        function applyUserSettings() {
            // 应用主题
            if (AppState.userSettings.theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            // 应用字体
            document.body.className = AppState.userSettings.font;
            
            // 如果有自定义字体链接，加载它
            if (AppState.userSettings.customFontLink) {
                loadCustomFont(AppState.userSettings.customFontLink);
            }
            
            // 更新用户名
            document.getElementById('userName').textContent = AppState.userSettings.name;
            document.getElementById('userNameInput').value = AppState.userSettings.name;
            document.getElementById('userBioInput').value = AppState.userSettings.bio || '';
            document.getElementById('userAvatarInput').value = AppState.userSettings.avatar || '';
            document.getElementById('userCoverInput').value = AppState.userSettings.cover || '';
            
            // 更新用户头像
            updateUserAvatar(AppState.userSettings.avatar);
            
            // 更新用户封面
            if (AppState.userSettings.cover) {
                document.getElementById('userCover').style.backgroundImage = `url('${AppState.userSettings.cover}')`;
                document.getElementById('userCover').style.backgroundSize = 'cover';
                document.getElementById('userCover').style.backgroundPosition = 'center';
            }
            
            // 应用头像框设置
            applyAvatarFrame(AppState.userSettings.avatarFrame);
            
            // 应用聊天框样式
            if (AppState.userSettings.customChatBubbleCSS) {
                applyCustomCSS(AppState.userSettings.customChatBubbleCSS + (AppState.customCSS || ''));
            }
            
            // 应用自定义头像框CSS
            if (AppState.userSettings.customAvatarFrameCSS) {
                const frameCSS = AppState.userSettings.customAvatarFrameCSS;
                if (!frameCSS.includes('.avatar-frame-custom')) {
                    // 如果没有定义.custom-avatar-frame类，添加它
                    applyCustomCSS('.avatar-frame-custom {' + frameCSS + '}' + (AppState.customCSS || ''));
                } else {
                    applyCustomCSS(frameCSS + (AppState.customCSS || ''));
                }
            }
            
            // 应用AI回复设置
            document.getElementById('aiResponseDelay').value = AppState.userSettings.aiResponseDelay;
            document.getElementById('delayValue').textContent = `${AppState.userSettings.aiResponseDelay}ms`;
            document.getElementById('enableTypingEffect').checked = AppState.userSettings.enableTypingEffect;
            document.getElementById('enableHumanLike').checked = AppState.userSettings.enableHumanLike;
            document.getElementById('enableEmotions').checked = AppState.userSettings.enableEmotions;
            document.getElementById('showDiaryNav').checked = AppState.userSettings.showDiaryNav;
            document.getElementById('showBeautifyNav').checked = AppState.userSettings.showBeautifyNav;
        }
        
        // 加载自定义字体
        function loadCustomFont(fontLink) {
            if (!fontLink) return;
            
            // 检查是否是Google Fonts链接
            if (fontLink.includes('fonts.googleapis.com')) {
                // 如果是Google Fonts链接，直接添加到head
                const existingLink = document.querySelector('link[href*="fonts.googleapis.com"]:not([rel="preconnect"])');
                if (existingLink) {
                    // 如果已经存在相同的字体链接，不重复添加
                    if (existingLink.href === fontLink) return;
                    existingLink.remove();
                }
                
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = fontLink;
                document.head.appendChild(link);
            } else {
                // 假设是CSS样式
                const style = document.createElement('style');
                style.textContent = fontLink;
                document.head.appendChild(style);
            }
        }
        
        // 更新用户头像
        function updateUserAvatar(avatarUrl) {
            const userAvatarLarge = document.getElementById('userAvatarLarge');
            if (avatarUrl && (avatarUrl.startsWith('data:image') || avatarUrl.startsWith('http'))) {
                userAvatarLarge.innerHTML = `
                    <img src="${avatarUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                    ${getAvatarFrameHTML()}
                `;
            } else {
                userAvatarLarge.innerHTML = `
                    <div style="width: 100%; height: 100%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #777;">
                        ${AppState.userSettings.name.charAt(0)}
                    </div>
                    ${getAvatarFrameHTML()}
                `;
            }
        }
        
        // 获取头像框HTML
        function getAvatarFrameHTML() {
            const frame = AppState.userSettings.avatarFrame;
            if (frame === 'default') {
                return '<div class="avatar-frame avatar-frame-default"></div>';
            } else if (frame === 'circle') {
                return '<div class="avatar-frame avatar-frame-circle"></div>';
            } else if (frame === 'heart') {
                return '<div class="avatar-frame avatar-frame-heart"></div>';
            } else if (frame === 'star') {
                return '<div class="avatar-frame avatar-frame-star"></div>';
            } else if (frame === 'custom') {
                return '<div class="avatar-frame avatar-frame-custom"></div>';
            }
            return '';
        }
        
        // 应用头像框
        function applyAvatarFrame(frameType) {
            // 更新所有头像框预览
            const frameOptions = document.querySelectorAll('.avatar-frame-option');
            frameOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-frame') === frameType) {
                    option.classList.add('active');
                }
            });
            
            // 更新预览
            const preview = document.getElementById('avatarFramePreview');
            preview.innerHTML = `
                <div style="width: 60px; height: 60px; border-radius: 50%; background-color: #4a90e2; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">AI</div>
                ${getAvatarFrameHTML()}
            `;
            
            // 重新渲染聊天列表和朋友圈以应用新头像框
            if (AppState.currentPage === 'chatList') {
                renderChatList();
            }
            if (AppState.currentPage === 'moments') {
                renderMoments();
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 启动页点击事件
            rynxLogo.addEventListener('click', handleSplashClick);
            rynxLogo.addEventListener('touchend', handleSplashClick);
            
            // 自动进入应用（1秒后）
            setTimeout(() => {
                if (!splashScreen.classList.contains('splash-hidden')) {
                    splashScreen.classList.add('splash-hidden');
                    setTimeout(() => {
                        appContainer.classList.add('app-visible');
                        initializeApp();
                    }, 300);
                }
            }, 1000);
            
            // 导航栏点击事件
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    
                    // 更新导航状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 显示对应页面
                    showPage(page);
                });
            });
            
            // 主题切换按钮
            document.getElementById('themeToggleBtn').addEventListener('click', function() {
                if (AppState.userSettings.theme === 'light') {
                    AppState.userSettings.theme = 'dark';
                    document.body.classList.add('dark-mode');
                    this.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    AppState.userSettings.theme = 'light';
                    document.body.classList.remove('dark-mode');
                    this.innerHTML = '<i class="fas fa-moon"></i>';
                }
                saveDataToLocalStorage('userSettings');
            });
            
            // 设置按钮
            document.getElementById('settingsBtn').addEventListener('click', function() {
                openSettingsModal();
            });
            
            // 聊天搜索
            document.getElementById('chatSearchInput').addEventListener('input', function() {
                filterChatList(this.value);
            });
            
            // 创建新人设按钮
            document.getElementById('createCharacterBtn').addEventListener('click', createCharacter);
            
            // 上传角色头像按钮
            document.getElementById('uploadCharAvatarBtn').addEventListener('click', function() {
                document.getElementById('charAvatarFile').click();
            });
            
            document.getElementById('charAvatarFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('charAvatar').value = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            // 创建新世界按钮
            document.getElementById('createWorldBtn').addEventListener('click', createWorldbook);
            
            // 新增分类按钮
            document.getElementById('addCategoryBtn').addEventListener('click', function() {
                const categoryName = prompt('请输入新分类名称:');
                if (categoryName && categoryName.trim()) {
                    if (!AppState.worldbookCategories.includes(categoryName.trim())) {
                        AppState.worldbookCategories.push(categoryName.trim());
                        saveDataToLocalStorage('worldbook_categories');
                        renderWorldbookCategories();
                        renderWorldbookCategoryOptions();
                    } else {
                        alert('该分类已存在!');
                    }
                }
            });
            
            // 保存API配置按钮
            document.getElementById('saveApiBtn').addEventListener('click', saveApiConfig);
            
            // 测试API连接按钮
            document.getElementById('testApiBtn').addEventListener('click', testApiConnection);
            
            // 发表朋友圈按钮
            document.getElementById('newMomentBtn').addEventListener('click', function() {
                openNewMomentModal();
            });
            
            // 保存字体设置按钮
            document.getElementById('saveFontBtn').addEventListener('click', saveFontSettings);
            
            // 保存头像框设置按钮
            document.getElementById('saveAvatarFrameBtn').addEventListener('click', saveAvatarFrameSettings);
            
            // 保存聊天框样式按钮
            document.getElementById('saveChatBubbleBtn').addEventListener('click', saveChatBubbleSettings);
            
            // 导出设置按钮
            document.getElementById('exportSettingsBtn').addEventListener('click', exportSettings);
            
            // 导入设置按钮
            document.getElementById('importSettingsBtn').addEventListener('click', importSettings);
            
            // 重置设置按钮
            document.getElementById('resetSettingsBtn').addEventListener('click', resetSettings);
            
            // 头像框选项点击事件
            document.querySelectorAll('.avatar-frame-option').forEach(option => {
                option.addEventListener('click', function() {
                    const frameType = this.getAttribute('data-frame');
                    AppState.userSettings.avatarFrame = frameType;
                    applyAvatarFrame(frameType);
                });
            });
            
            // 模态框关闭按钮
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });
            
            // 聊天背景设置
            document.getElementById('chatBgSetting').addEventListener('click', function() {
                document.getElementById('chatSettingsMenu').classList.remove('active');
                openChatBgModal();
            });
            
            // 世界书挂载设置
            document.getElementById('worldbookSetting').addEventListener('click', function() {
                document.getElementById('chatSettingsMenu').classList.remove('active');
                openWorldbookMountModal();
            });
            
            // 清空聊天记录
            document.getElementById('clearChatHistory').addEventListener('click', function() {
                document.getElementById('chatSettingsMenu').classList.remove('active');
                if (confirm('确定要清空当前聊天记录吗？此操作不可撤销。')) {
                    if (AppState.currentChat) {
                        AppState.currentChat.messages = [];
                        saveDataToLocalStorage('chats');
                        renderChatMessages();
                    }
                }
            });
            
            // 导出聊天记录
            document.getElementById('exportChatHistory').addEventListener('click', function() {
                document.getElementById('chatSettingsMenu').classList.remove('active');
                if (AppState.currentChat) {
                    exportChatHistory(AppState.currentChat);
                }
            });
            
            // 背景透明度滑块
            document.getElementById('chatBgOpacity').addEventListener('input', function() {
                document.getElementById('opacityValue').textContent = `${Math.round(this.value * 100)}%`;
            });
            
            // AI回复延迟滑块
            document.getElementById('aiResponseDelay').addEventListener('input', function() {
                document.getElementById('delayValue').textContent = `${this.value}ms`;
            });
        }
        
        // 处理启动页点击
        function handleSplashClick(e) {
            e.preventDefault();
            e.stopPropagation();
            splashScreen.classList.add('splash-hidden');
            setTimeout(() => {
                appContainer.classList.add('app-visible');
                initializeApp();
            }, 300);
        }
        
        // 显示页面
        function showPage(pageName) {
            // 更新当前页面状态
            AppState.currentPage = pageName;
            
            // 隐藏所有页面
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            let targetPageId;
            switch(pageName) {
                case 'chatList':
                    targetPageId = 'chatListPage';
                    headerTitle.innerHTML = '<i class="fas fa-comments"></i><span>聊天</span>';
                    break;
                case 'moments':
                    targetPageId = 'momentsPage';
                    headerTitle.innerHTML = '<i class="fas fa-newspaper"></i><span>朋友圈</span>';
                    break;
                case 'worldbook':
                    targetPageId = 'worldbookPage';
                    headerTitle.innerHTML = '<i class="fas fa-globe"></i><span>世界书</span>';
                    break;
                case 'api':
                    targetPageId = 'apiPage';
                    headerTitle.innerHTML = '<i class="fas fa-key"></i><span>API设置</span>';
                    break;
                case 'character':
                    targetPageId = 'characterPage';
                    headerTitle.innerHTML = '<i class="fas fa-user-astronaut"></i><span>人设管理</span>';
                    break;
                case 'diary':
                    targetPageId = 'diaryPage';
                    headerTitle.innerHTML = '<i class="fas fa-book"></i><span>AI日记</span>';
                    break;
                case 'beautify':
                    targetPageId = 'beautifyPage';
                    headerTitle.innerHTML = '<i class="fas fa-palette"></i><span>美化设置</span>';
                    break;
                default:
                    targetPageId = 'chatListPage';
            }
            
            document.getElementById(targetPageId).classList.add('active');
            
            // 滚动到顶部
            pagesContainer.scrollTop = 0;
        }
        
        // 更新导航栏可见性
        function updateNavVisibility() {
            const diaryNavItem = document.getElementById('diaryNavItem');
            const beautifyNavItem = document.getElementById('beautifyNavItem');
            
            if (AppState.userSettings.showDiaryNav) {
                diaryNavItem.classList.remove('hidden');
            } else {
                diaryNavItem.classList.add('hidden');
            }
            
            if (AppState.userSettings.showBeautifyNav) {
                beautifyNavItem.classList.remove('hidden');
            } else {
                beautifyNavItem.classList.add('hidden');
            }
        }
        
        // 更新未读消息数
        function updateUnreadBadge() {
            let unreadCount = 0;
            AppState.chats.forEach(chat => {
                unreadCount += chat.unread || 0;
            });
            
            const chatBadge = document.getElementById('chatBadge');
            if (unreadCount > 0) {
                chatBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                chatBadge.classList.remove('hidden');
            } else {
                chatBadge.classList.add('hidden');
            }
        }
        
        // 渲染聊天列表
        function renderChatList() {
            const chatListContainer = document.getElementById('chatListContainer');
            chatListContainer.innerHTML = '';
            
            if (AppState.chats.length === 0) {
                chatListContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>暂无聊天</h3>
                        <p>点击下方按钮开始新的聊天</p>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button class="btn btn-primary btn-small" id="startSingleChatBtn">
                                <i class="fas fa-user"></i>
                                单聊
                            </button>
                            <button class="btn btn-primary btn-small" id="startGroupChatBtn">
                                <i class="fas fa-users"></i>
                                群聊
                            </button>
                        </div>
                    </div>
                `;
                
                // 添加按钮事件监听器
                document.getElementById('startSingleChatBtn').addEventListener('click', function() {
                    if (AppState.characters.length === 0) {
                        alert('请先创建至少一个AI角色');
                        showPage('character');
                        return;
                    }
                    AppState.isGroupChat = false;
                    openSelectAiModal();
                });
                
                document.getElementById('startGroupChatBtn').addEventListener('click', function() {
                    if (AppState.characters.length < 2) {
                        alert('群聊需要至少两个AI角色，请先创建更多角色');
                        showPage('character');
                        return;
                    }
                    openGroupChatModal();
                });
                
                return;
            }
            
            // 添加创建聊天按钮
            const createChatSection = document.createElement('div');
            createChatSection.style.padding = '15px';
            createChatSection.style.borderBottom = '1px solid var(--border-color)';
            createChatSection.style.backgroundColor = 'var(--card-bg)';
            createChatSection.innerHTML = `
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary btn-small" id="newSingleChatBtn2" style="flex: 1;">
                        <i class="fas fa-user-plus"></i>
                        单聊
                    </button>
                    <button class="btn btn-primary btn-small" id="newGroupChatBtn2" style="flex: 1;">
                        <i class="fas fa-users"></i>
                        群聊
                    </button>
                </div>
            `;
            chatListContainer.appendChild(createChatSection);
            
            // 添加按钮事件监听器
            document.getElementById('newSingleChatBtn2').addEventListener('click', function() {
                if (AppState.characters.length === 0) {
                    alert('请先创建至少一个AI角色');
                    showPage('character');
                    return;
                }
                AppState.isGroupChat = false;
                openSelectAiModal();
            });
            
            document.getElementById('newGroupChatBtn2').addEventListener('click', function() {
                if (AppState.characters.length < 2) {
                    alert('群聊需要至少两个AI角色，请先创建更多角色');
                    showPage('character');
                    return;
                }
                openGroupChatModal();
            });
            
            // 渲染聊天列表
            AppState.chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.setAttribute('data-chat-id', chat.id);
                
                // 获取聊天最后一条消息
                let lastMessage = '暂无消息';
                let lastMessageTime = new Date(chat.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                if (chat.messages && chat.messages.length > 0) {
                    const lastMsg = chat.messages[chat.messages.length - 1];
                    lastMessage = lastMsg.text.length > 30 ? lastMsg.text.substring(0, 30) + '...' : lastMsg.text;
                    lastMessageTime = new Date(lastMsg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                // 获取聊天头像和名称
                let chatAvatar = '💬';
                let chatName = chat.name;
                
                // 如果是单聊，尝试获取角色头像
                if (chat.type === 'single' && chat.members && chat.members.length > 0) {
                    const character = AppState.characters.find(c => c.id === chat.members[0]);
                    if (character) {
                        chatName = character.name;
                        if (character.avatar) {
                            chatAvatar = `<img src="${character.avatar}" class="avatar-img" alt="${character.name}">`;
                        } else {
                            chatAvatar = character.name.charAt(0);
                        }
                    }
                }
                
                // 添加头像框
                let avatarFrame = '';
                if (AppState.userSettings.avatarFrame !== 'none') {
                    avatarFrame = getAvatarFrameHTML();
                }
                
                chatItem.innerHTML = `
                    <div class="avatar">
                        ${chatAvatar}
                        ${avatarFrame}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name-row">
                            <div class="chat-name">${chatName}</div>
                            <div class="chat-time">${lastMessageTime}</div>
                        </div>
                        <div class="chat-preview">${lastMessage}</div>
                    </div>
                    ${chat.unread && chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
                `;
                
                chatItem.addEventListener('click', function() {
                    const chatId = parseInt(this.getAttribute('data-chat-id'));
                    openChatRoom(chatId);
                });
                
                chatItem.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    const chatId = parseInt(this.getAttribute('data-chat-id'));
                    openChatRoom(chatId);
                });
                
                chatListContainer.appendChild(chatItem);
            });
        }
        
        // 过滤聊天列表
        function filterChatList(query) {
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-name').textContent.toLowerCase();
                const chatPreview = item.querySelector('.chat-preview').textContent.toLowerCase();
                const searchQuery = query.toLowerCase();
                
                if (chatName.includes(searchQuery) || chatPreview.includes(searchQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // 打开选择AI对话框
        function openSelectAiModal() {
            const selectAiModal = document.getElementById('selectAiModal');
            const selectAiList = document.getElementById('selectAiList');
            const selectAiTitle = document.getElementById('selectAiTitle');
            
            // 设置对话框标题
            selectAiTitle.textContent = AppState.isGroupChat ? '选择AI角色 (可多选)' : '选择聊天对象';
            
            // 清空列表
            selectAiList.innerHTML = '';
            
            // 重置选择状态
            AppState.selectedAIs = [];
            
            // 添加AI角色到列表
            AppState.characters.forEach(character => {
                const aiItem = document.createElement('div');
                aiItem.className = 'chat-item';
                aiItem.setAttribute('data-character-id', character.id);
                aiItem.style.cursor = 'pointer';
                
                // 获取头像框
                let avatarFrame = '';
                if (AppState.userSettings.avatarFrame !== 'none') {
                    avatarFrame = getAvatarFrameHTML();
                }
                
                aiItem.innerHTML = `
                    <div class="avatar">
                        ${character.avatar ? 
                            `<img src="${character.avatar}" class="avatar-img" alt="${character.name}">` : 
                            character.name.charAt(0)
                        }
                        ${avatarFrame}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name-row">
                            <div class="chat-name">${character.name}</div>
                        </div>
                        <div class="chat-preview">${character.gender === 'male' ? '男' : character.gender === 'female' ? '女' : '其他'} · ${character.age}岁</div>
                    </div>
                    <div class="unread-badge" style="background-color: transparent; color: var(--text-light);">
                        <i class="far fa-circle"></i>
                    </div>
                `;
                
                aiItem.addEventListener('click', function() {
                    const characterId = character.id;
                    const selectedBadge = this.querySelector('.unread-badge');
                    
                    if (AppState.isGroupChat) {
                        // 群聊：多选
                        if (AppState.selectedAIs.includes(characterId)) {
                            // 取消选择
                            AppState.selectedAIs = AppState.selectedAIs.filter(id => id !== characterId);
                            selectedBadge.innerHTML = '<i class="far fa-circle"></i>';
                            selectedBadge.style.color = 'var(--text-light)';
                        } else {
                            // 选择
                            AppState.selectedAIs.push(characterId);
                            selectedBadge.innerHTML = '<i class="fas fa-check-circle" style="color: var(--primary-color);"></i>';
                        }
                    } else {
                        // 单聊：单选
                        // 先清除所有选择
                        document.querySelectorAll('#selectAiList .chat-item .unread-badge').forEach(badge => {
                            badge.innerHTML = '<i class="far fa-circle"></i>';
                            badge.style.color = 'var(--text-light)';
                        });
                        
                        // 选择当前项
                        AppState.selectedAIs = [characterId];
                        selectedBadge.innerHTML = '<i class="fas fa-check-circle" style="color: var(--primary-color);"></i>';
                    }
                });
                
                selectAiList.appendChild(aiItem);
            });
            
            // 添加搜索功能
            document.getElementById('aiSearchInput').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const aiItems = selectAiList.querySelectorAll('.chat-item');
                
                aiItems.forEach(item => {
                    const characterName = item.querySelector('.chat-name').textContent.toLowerCase();
                    const characterDesc = item.querySelector('.chat-preview').textContent.toLowerCase();
                    
                    if (characterName.includes(query) || characterDesc.includes(query)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // 显示对话框
            selectAiModal.classList.add('active');
            
            // 添加确认按钮事件
            document.getElementById('confirmSelectAiBtn').onclick = function() {
                if (AppState.selectedAIs.length === 0) {
                    alert('请至少选择一个AI角色');
                    return;
                }
                
                if (!AppState.isGroupChat && AppState.selectedAIs.length > 1) {
                    alert('单聊只能选择一个AI角色');
                    return;
                }
                
                selectAiModal.classList.remove('active');
                
                if (AppState.isGroupChat) {
                    // 群聊需要输入群名称
                    openGroupChatModal();
                } else {
                    // 单聊直接创建
                    createChat();
                }
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelSelectAiBtn').onclick = function() {
                selectAiModal.classList.remove('active');
            };
        }
        
        // 打开群聊对话框
        function openGroupChatModal() {
            const groupChatModal = document.getElementById('groupChatModal');
            const groupAiList = document.getElementById('groupAiList');
            
            // 清空列表
            groupAiList.innerHTML = '';
            
            // 如果已经选择了AI，设置选中状态
            const selectedAIs = AppState.selectedAIs.length > 0 ? [...AppState.selectedAIs] : [];
            
            // 添加AI角色到列表
            AppState.characters.forEach(character => {
                const aiItem = document.createElement('div');
                aiItem.className = 'chat-item';
                aiItem.setAttribute('data-character-id', character.id);
                aiItem.style.cursor = 'pointer';
                
                const isSelected = selectedAIs.includes(character.id);
                
                // 获取头像框
                let avatarFrame = '';
                if (AppState.userSettings.avatarFrame !== 'none') {
                    avatarFrame = getAvatarFrameHTML();
                }
                
                aiItem.innerHTML = `
                    <div class="avatar">
                        ${character.avatar ? 
                            `<img src="${character.avatar}" class="avatar-img" alt="${character.name}">` : 
                            character.name.charAt(0)
                        }
                        ${avatarFrame}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name-row">
                            <div class="chat-name">${character.name}</div>
                        </div>
                        <div class="chat-preview">${character.gender === 'male' ? '男' : character.gender === 'female' ? '女' : '其他'} · ${character.age}岁</div>
                    </div>
                    <div class="unread-badge" style="background-color: transparent; color: var(--text-light);">
                        ${isSelected ? 
                            '<i class="fas fa-check-circle" style="color: var(--primary-color);"></i>' : 
                            '<i class="far fa-circle"></i>'
                        }
                    </div>
                `;
                
                aiItem.addEventListener('click', function() {
                    const characterId = character.id;
                    const selectedBadge = this.querySelector('.unread-badge');
                    
                    if (selectedAIs.includes(characterId)) {
                        // 取消选择
                        const index = selectedAIs.indexOf(characterId);
                        selectedAIs.splice(index, 1);
                        selectedBadge.innerHTML = '<i class="far fa-circle"></i>';
                        selectedBadge.style.color = 'var(--text-light)';
                    } else {
                        // 选择
                        selectedAIs.push(characterId);
                        selectedBadge.innerHTML = '<i class="fas fa-check-circle" style="color: var(--primary-color);"></i>';
                    }
                    
                    // 更新全局选择状态
                    AppState.selectedAIs = [...selectedAIs];
                });
                
                groupAiList.appendChild(aiItem);
            });
            
            // 添加搜索功能
            document.getElementById('groupAiSearchInput').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const aiItems = groupAiList.querySelectorAll('.chat-item');
                
                aiItems.forEach(item => {
                    const characterName = item.querySelector('.chat-name').textContent.toLowerCase();
                    const characterDesc = item.querySelector('.chat-preview').textContent.toLowerCase();
                    
                    if (characterName.includes(query) || characterDesc.includes(query)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // 设置默认群聊名称
            if (selectedAIs.length > 0) {
                const selectedNames = AppState.characters
                    .filter(c => selectedAIs.includes(c.id))
                    .map(c => c.name);
                document.getElementById('groupChatName').value = selectedNames.join('、') + '的群聊';
            }
            
            // 显示对话框
            groupChatModal.classList.add('active');
            
            // 添加确认按钮事件
            document.getElementById('confirmGroupChatBtn').onclick = function() {
                const groupName = document.getElementById('groupChatName').value.trim();
                
                if (!groupName) {
                    alert('请输入群聊名称');
                    return;
                }
                
                if (selectedAIs.length < 2) {
                    alert('群聊需要至少两个AI角色');
                    return;
                }
                
                AppState.isGroupChat = true;
                groupChatModal.classList.remove('active');
                createChat();
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelGroupChatBtn').onclick = function() {
                groupChatModal.classList.remove('active');
            };
        }
        
        // 创建聊天
        function createChat() {
            // 获取选中的角色
            const selectedCharacters = AppState.characters.filter(c => AppState.selectedAIs.includes(c.id));
            
            if (selectedCharacters.length === 0) {
                alert('未找到选中的角色');
                return;
            }
            
            // 生成聊天名称
            let chatName;
            if (AppState.isGroupChat) {
                chatName = document.getElementById('groupChatName').value.trim();
                if (!chatName) {
                    chatName = selectedCharacters.map(c => c.name).join('、') + '的群聊';
                }
            } else {
                chatName = selectedCharacters[0].name;
            }
            
            // 创建新聊天ID
            const newChatId = AppState.chats.length > 0 ? Math.max(...AppState.chats.map(c => c.id)) + 1 : 1;
            
            const newChat = {
                id: newChatId,
                name: chatName,
                type: AppState.isGroupChat ? 'group' : 'single',
                members: AppState.selectedAIs,
                messages: [],
                unread: 0,
                createdAt: new Date().toISOString()
            };
            
            AppState.chats.push(newChat);
            saveDataToLocalStorage('chats');
            
            // 打开聊天室
            openChatRoom(newChatId);
            
            // 重置选择状态
            AppState.selectedAIs = [];
        }
        
        // 打开聊天室
        function openChatRoom(chatId) {
            const chat = AppState.chats.find(c => c.id === chatId);
            if (!chat) return;
            
            AppState.currentChat = chat;
            
            // 重置未读消息数
            chat.unread = 0;
            saveDataToLocalStorage('chats');
            updateUnreadBadge();
            
            // 生成聊天室HTML
            const chatRoomPage = document.getElementById('chatRoomPage');
            chatRoomPage.innerHTML = '';
            
            // 获取聊天成员
            const chatMembers = AppState.characters.filter(c => chat.members.includes(c.id));
            
            // 生成聊天室头部
            const chatHeader = document.createElement('div');
            chatHeader.className = 'chat-room-header';
            
            // 获取聊天背景
            const chatBg = AppState.chatBackgrounds[chatId] || { type: 'none', opacity: 0.15 };
            
            // 检查世界书挂载状态
            const worldbookMount = AppState.worldbookMounts[chatId];
            let worldbookIndicator = '';
            if (worldbookMount && worldbookMount.enabled && worldbookMount.worldbookId) {
                const worldbook = AppState.worldbooks.find(w => w.id === worldbookMount.worldbookId);
                if (worldbook) {
                    worldbookIndicator = `
                        <span class="worldbook-indicator" id="worldbookIndicator">
                            <i class="fas fa-check"></i>
                            <span id="currentWorldbookName">${worldbook.name}</span>
                        </span>
                    `;
                }
            }
            
            chatHeader.innerHTML = `
                <button class="back-btn" id="backFromChatBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-header-info">
                    <div class="chat-header-avatar">
                        ${chat.type === 'group' ? 
                            '<i class="fas fa-users" style="font-size: 1.5rem; color: var(--text-secondary); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></i>' :
                            (chatMembers[0] && chatMembers[0].avatar ? 
                                `<img src="${chatMembers[0].avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #e0e0e0; color: #777; font-weight: bold;">${chatMembers[0] ? chatMembers[0].name.charAt(0) : '?'}</div>`
                            )
                        }
                        ${AppState.userSettings.avatarFrame !== 'none' ? getAvatarFrameHTML() : ''}
                    </div>
                    <div>
                        <div class="chat-header-name">${chat.name}</div>
                        <div class="chat-header-status">
                            ${chat.type === 'group' ? 
                                `${chatMembers.length} 位成员` : 
                                '在线'
                            }
                            ${worldbookIndicator}
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="chatMenuBtn" title="聊天设置">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            `;
            
            // 生成消息区域
            const messagesArea = document.createElement('div');
            messagesArea.className = 'chat-messages';
            messagesArea.id = 'chatMessages';
            
            // 生成输入区域
            const inputArea = document.createElement('div');
            inputArea.className = 'chat-input-area';
            inputArea.innerHTML = `
                <button class="input-action-btn" id="emojiBtn" title="表情">
                    <i class="far fa-smile"></i>
                </button>
                <textarea class="chat-input" id="chatMessageInput" placeholder="输入消息..." rows="1"></textarea>
                <button class="input-action-btn ai-reply-btn" id="aiReplyBtn" title="让AI回复">
                    <i class="fas fa-robot"></i>
                </button>
                <button class="input-action-btn send-btn" id="sendChatMessageBtn" title="发送">
                    <i class="fas fa-paper-plane"></i>
                </button>
            `;
            
            // 创建聊天背景
            const chatBgDiv = document.createElement('div');
            chatBgDiv.className = 'chat-room-bg';
            chatBgDiv.id = 'chatRoomBg';
            
            // 设置聊天背景
            if (chatBg.type === 'color' || chatBg.type === 'gradient') {
                chatBgDiv.style.background = chatBg.value;
                chatBgDiv.style.opacity = chatBg.opacity || 0.15;
            } else if (chatBg.type === 'image') {
                chatBgDiv.style.backgroundImage = `url('${chatBg.value}')`;
                chatBgDiv.style.opacity = chatBg.opacity || 0.15;
            }
            
            // 创建聊天内容容器
            const chatContent = document.createElement('div');
            chatContent.className = 'chat-room-content';
            
            // 组装聊天室
            chatRoomPage.appendChild(chatBgDiv);
            chatRoomPage.appendChild(chatContent);
            chatContent.appendChild(chatHeader);
            chatContent.appendChild(messagesArea);
            chatContent.appendChild(inputArea);
            
            // 显示聊天室
            pages.forEach(page => page.classList.remove('active'));
            chatRoomPage.classList.add('active');
            
            // 更新标题
            headerTitle.innerHTML = `<i class="fas fa-comments"></i><span>${chat.name}</span>`;
            
            // 渲染消息
            renderChatMessages();
            
            // 添加返回按钮事件
            document.getElementById('backFromChatBtn').addEventListener('click', function() {
                showPage('chatList');
                headerTitle.innerHTML = '<i class="fas fa-comments"></i><span>聊天</span>';
                renderChatList();
            });
            
            // 添加聊天菜单按钮事件
            document.getElementById('chatMenuBtn').addEventListener('click', function(e) {
                const menu = document.getElementById('chatSettingsMenu');
                menu.style.top = (e.target.getBoundingClientRect().bottom + 5) + 'px';
                menu.style.right = '15px';
                menu.classList.toggle('active');
            });
            
            // 点击其他地方关闭菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#chatMenuBtn') && !e.target.closest('#chatSettingsMenu')) {
                    document.getElementById('chatSettingsMenu').classList.remove('active');
                }
            });
            
            // 添加发送消息事件
            document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);
            document.getElementById('chatMessageInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // 添加AI回复按钮事件
            document.getElementById('aiReplyBtn').addEventListener('click', triggerAIResponse);
            
            // 调整输入框高度
            const chatInput = document.getElementById('chatMessageInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // 滚动到底部
            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
        }
        
        // 渲染聊天消息
        function renderChatMessages() {
            const messagesArea = document.getElementById('chatMessages');
            if (!messagesArea) return;
            
            messagesArea.innerHTML = '';
            
            if (!AppState.currentChat || !AppState.currentChat.messages || AppState.currentChat.messages.length === 0) {
                messagesArea.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-comment-slash" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>开始聊天</h3>
                        <p>发送第一条消息开始对话</p>
                    </div>
                `;
                return;
            }
            
            AppState.currentChat.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.senderType === 'user' ? 'user' : message.senderType === 'system' ? 'system' : 'ai'}`;
                
                // 获取发送者信息
                let senderName = '你';
                let avatar = '';
                
                if (message.senderType === 'ai') {
                    const character = AppState.characters.find(c => c.id === message.senderId);
                    senderName = character ? character.name : 'AI';
                    
                    if (character && character.avatar) {
                        avatar = character.avatar;
                    }
                } else if (message.senderType === 'system') {
                    senderName = '系统';
                }
                
                // 格式化时间
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // 构建消息内容
                let messageContent = message.text;
                let quoteHtml = '';
                let transferHtml = '';
                
                if (message.quote) {
                    quoteHtml = `
                        <div class="message-quote">
                            <strong>引用:</strong> ${message.quote}
                        </div>
                    `;
                }
                
                if (message.type === 'transfer') {
                    const statusText = message.transferStatus === 'completed' ? '已到账' : 
                                     message.transferStatus === 'pending' ? '处理中' : '已拒绝';
                    const statusColor = message.transferStatus === 'completed' ? 'var(--primary-color)' : 
                                      message.transferStatus === 'pending' ? 'var(--warning-color)' : 'var(--danger-color)';
                    
                    transferHtml = `
                        <div class="transfer-message">
                            <div class="transfer-title">${message.transferTo === 'user' ? '收到转账' : '转账给' + message.transferTo}</div>
                            <div class="transfer-amount">¥${message.amount.toFixed(2)}</div>
                            <div class="transfer-status" style="color: ${statusColor}">${statusText}</div>
                            ${message.note ? `<div class="transfer-status">备注: ${message.note}</div>` : ''}
                        </div>
                    `;
                }
                
                // 获取头像框
                let avatarFrame = '';
                if (AppState.userSettings.avatarFrame !== 'none') {
                    avatarFrame = getAvatarFrameHTML();
                }
                
                messageElement.innerHTML = `
                    ${message.senderType === 'ai' ? `
                        <div class="message-sender">
                            <div class="message-avatar">
                                ${avatar ? `<img src="${avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #4a90e2; color: white; font-weight: bold;">${senderName.charAt(0)}</div>`}
                                ${avatarFrame}
                            </div>
                            ${senderName}
                        </div>
                    ` : ''}
                    
                    <div class="message-bubble">
                        ${quoteHtml}
                        ${transferHtml || `<div class="message-content">${messageContent}</div>`}
                        <div class="message-time">${time}</div>
                        
                        ${message.senderType === 'user' ? `
                            <div class="message-actions">
                                <button class="message-action-btn" data-message-id="${message.id}" data-action="quote">
                                    <i class="fas fa-quote-left"></i> 引用
                                </button>
                                ${message.type !== 'transfer' ? `
                                    <button class="message-action-btn" data-message-id="${message.id}" data-action="delete">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                messagesArea.appendChild(messageElement);
            });
            
            // 添加消息操作事件
            messagesArea.querySelectorAll('.message-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const messageId = parseInt(this.getAttribute('data-message-id'));
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'quote') {
                        const message = AppState.currentChat.messages.find(m => m.id === messageId);
                        if (message) {
                            document.getElementById('chatMessageInput').value += `[引用: ${message.text}] `;
                            document.getElementById('chatMessageInput').focus();
                        }
                    } else if (action === 'delete') {
                        if (confirm('确定要删除这条消息吗？')) {
                            AppState.currentChat.messages = AppState.currentChat.messages.filter(m => m.id !== messageId);
                            saveDataToLocalStorage('chats');
                            renderChatMessages();
                        }
                    }
                });
            });
        }
        
        // 发送聊天消息
        function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const messageText = input.value.trim();
            
            if (!messageText || !AppState.currentChat) return;
            
            // 添加发送反馈
            const sendBtn = document.getElementById('sendChatMessageBtn');
            const originalHTML = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-check"></i>';
            sendBtn.style.backgroundColor = 'var(--secondary-color)';
            
            setTimeout(() => {
                sendBtn.innerHTML = originalHTML;
                sendBtn.style.backgroundColor = '';
            }, 300);
            
            // 创建消息ID
            const messageId = AppState.currentChat.messages.length > 0 ? 
                Math.max(...AppState.currentChat.messages.map(m => m.id)) + 1 : 1;
            
            // 检查是否是转账消息
            let messageType = 'text';
            let transferData = null;
            
            if (messageText.startsWith('/transfer')) {
                // 解析转账命令
                const parts = messageText.split(' ');
                if (parts.length >= 3) {
                    const to = parts[1];
                    const amount = parseFloat(parts[2]);
                    const note = parts.slice(3).join(' ') || '';
                    
                    if (!isNaN(amount) && amount > 0) {
                        messageType = 'transfer';
                        transferData = {
                            to,
                            amount,
                            note,
                            status: 'completed'
                        };
                        
                        // 更新余额
                        AppState.userBalance -= amount;
                        saveDataToLocalStorage('userBalance');
                    }
                }
            }
            
            // 创建用户消息
            const userMessage = {
                id: messageId,
                senderType: 'user',
                senderId: null,
                text: messageText,
                type: messageType,
                transferTo: transferData ? transferData.to : null,
                amount: transferData ? transferData.amount : null,
                note: transferData ? transferData.note : null,
                transferStatus: transferData ? transferData.status : null,
                timestamp: new Date().toISOString()
            };
            
            AppState.currentChat.messages.push(userMessage);
            saveDataToLocalStorage('chats');
            
            // 清空输入框并重置高度
            input.value = '';
            input.style.height = 'auto';
            
            // 重新渲染消息
            renderChatMessages();
            
            // 滚动到底部
            const messagesArea = document.getElementById('chatMessages');
            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
            
            // 如果是转账消息，添加系统确认消息
            if (messageType === 'transfer') {
                setTimeout(() => {
                    const systemMessageId = AppState.currentChat.messages.length > 0 ? 
                        Math.max(...AppState.currentChat.messages.map(m => m.id)) + 1 : 1;
                    
                    const systemMessage = {
                        id: systemMessageId,
                        senderType: 'system',
                        senderId: null,
                        text: `转账成功！已向${transferData.to}转账¥${transferData.amount.toFixed(2)}。`,
                        timestamp: new Date().toISOString()
                    };
                    
                    AppState.currentChat.messages.push(systemMessage);
                    saveDataToLocalStorage('chats');
                    renderChatMessages();
                    
                    // 再次滚动到底部
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                }, 500);
            }
            
            // 如果启用了AI自动回复，触发AI回复
            if (AppState.currentChat.type === 'single') {
                setTimeout(() => {
                    triggerAIResponse();
                }, 1000);
            }
        }
        
        // 触发AI回复
        function triggerAIResponse() {
            if (!AppState.currentChat) return;
            
            // 获取聊天中的AI角色
            const aiCharacters = AppState.characters.filter(c => AppState.currentChat.members.includes(c.id));
            
            if (aiCharacters.length === 0) return;
            
            // 获取当前聊天的世界书挂载
            const worldbookMount = AppState.worldbookMounts[AppState.currentChat.id];
            let worldbookContext = '';
            
            if (worldbookMount && worldbookMount.enabled && worldbookMount.worldbookId) {
                const worldbook = AppState.worldbooks.find(w => w.id === worldbookMount.worldbookId);
                if (worldbook) {
                    worldbookContext = `\n\n当前对话发生在以下世界背景中，请根据这个世界背景进行回复：
世界名称：${worldbook.name}
世界描述：${worldbook.description}
世界规则：${worldbook.rules}
世界背景：${worldbook.lore}`;
                }
            }
            
            // 获取最近的几条消息作为上下文
            const recentMessages = AppState.currentChat.messages.slice(-5);
            let conversationContext = '';
            recentMessages.forEach(msg => {
                const sender = msg.senderType === 'user' ? '用户' : 
                             msg.senderType === 'ai' ? (AppState.characters.find(c => c.id === msg.senderId)?.name || 'AI') : '系统';
                conversationContext += `${sender}: ${msg.text}\n`;
            });
            
            // 获取当前回复的AI角色
            let aiCharacter;
            if (AppState.currentChat.type === 'single') {
                aiCharacter = aiCharacters[0];
            } else {
                // 群聊中随机选择一个AI回复
                aiCharacter = aiCharacters[Math.floor(Math.random() * aiCharacters.length)];
            }
            
            // 构建AI角色设定
            const aiPersonality = `你是一个AI角色，以下是你的设定：
姓名：${aiCharacter.name}
性别：${aiCharacter.gender === 'male' ? '男' : aiCharacter.gender === 'female' ? '女' : '其他'}
年龄：${aiCharacter.age}岁
性格特点：${aiCharacter.personality || '未指定'}
背景故事：${aiCharacter.background || '未指定'}
喜好：${aiCharacter.likes || '未指定'}
厌恶：${aiCharacter.dislikes || '未指定'}`;
            
            // 构建用户人设（如果有）
            const userPersonality = aiCharacter.userPersonality ? `\n\n与你对话的用户设定：${aiCharacter.userPersonality}` : '';
            
            // 构建完整的提示
            const prompt = `${aiPersonality}${userPersonality}${worldbookContext}\n\n以下是你与用户的最近对话：
${conversationContext}
请根据你的角色设定${worldbookContext ? '和世界背景' : ''}，以${aiCharacter.name}的身份回复用户。${AppState.userSettings.enableHumanLike ? '请使用拟人化的表达方式，展现角色的个性特点。' : ''}${AppState.userSettings.enableEmotions ? '可以适当表达情感。' : ''}`;
            
            // 显示打字效果
            if (AppState.userSettings.enableTypingEffect) {
                showTypingIndicator(aiCharacter);
            }
            
            // 显示API调用状态
            showApiStatusIndicator(true);
            
            // 模拟API调用延迟
            setTimeout(() => {
                // 隐藏打字效果
                if (AppState.userSettings.enableTypingEffect) {
                    hideTypingIndicator();
                }
                
                // 生成AI回复
                const aiResponse = generateAIResponse(prompt, aiCharacter);
                
                // 创建AI消息
                const aiMessage = {
                    id: AppState.currentChat.messages.length + 1,
                    senderType: 'ai',
                    senderId: aiCharacter.id,
                    text: aiResponse,
                    timestamp: new Date().toISOString()
                };
                
                AppState.currentChat.messages.push(aiMessage);
                saveDataToLocalStorage('chats');
                
                // 重新渲染消息
                renderChatMessages();
                
                // 隐藏API调用状态
                showApiStatusIndicator(false);
                
                // 滚动到底部
                const messagesArea = document.getElementById('chatMessages');
                setTimeout(() => {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 100);
                
                // 随机生成一篇日记（10%概率）
                if (Math.random() < 0.1) {
                    generateAI Diary(aiCharacter.id, conversationContext);
                }
            }, AppState.userSettings.aiResponseDelay);
        }
        
        // 显示打字效果指示器
        function showTypingIndicator(character) {
            const messagesArea = document.getElementById('chatMessages');
            if (!messagesArea) return;
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message ai';
            typingIndicator.id = 'typingIndicator';
            
            typingIndicator.innerHTML = `
                <div class="message-sender">
                    <div class="message-avatar">
                        ${character.avatar ? `<img src="${character.avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #4a90e2; color: white; font-weight: bold;">${character.name.charAt(0)}</div>`}
                        ${AppState.userSettings.avatarFrame !== 'none' ? getAvatarFrameHTML() : ''}
                    </div>
                    ${character.name}
                </div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesArea.appendChild(typingIndicator);
            
            // 滚动到底部
            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
        }
        
        // 隐藏打字效果指示器
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // 显示API状态指示器
        function showApiStatusIndicator(show) {
            const indicator = document.getElementById('apiStatusIndicator');
            if (show) {
                indicator.style.display = 'flex';
            } else {
                indicator.style.display = 'none';
            }
        }
        
        // 生成AI回复（模拟API调用）
        function generateAIResponse(prompt, character) {
            // 这里是模拟的AI回复生成逻辑
            // 基于角色性格和对话上下文生成回复
            const responses = {
                friendly: [
                    "我明白你的意思了，这真是个有趣的观点！",
                    "谢谢分享，我对这个话题也很感兴趣。",
                    "你的想法很有创意，让我也想到了一些相关的点。",
                    "我理解你的感受，有时候确实会有这样的想法。"
                ],
                professional: [
                    "从专业角度来看，这个问题可以这样理解...",
                    "根据我的分析，这个情况可能有以下几种解释。",
                    "在技术层面上，我们可以考虑以下解决方案。",
                    "基于现有的数据和信息，我的建议是..."
                ],
                casual: [
                    "哈哈，这个挺有意思的！",
                    "我懂你的意思，确实是这样。",
                    "哇，没想到你会提到这个！",
                    "这个想法不错，我喜欢！"
                ]
            };
            
            // 根据角色性格选择回复风格
            let responseStyle = 'friendly';
            if (character.personality && character.personality.includes('专业')) {
                responseStyle = 'professional';
            } else if (character.personality && (character.personality.includes('随意') || character.personality.includes('轻松'))) {
                responseStyle = 'casual';
            }
            
            // 获取对应风格的回复列表
            const styleResponses = responses[responseStyle];
            
            // 随机选择一个回复
            let response = styleResponses[Math.floor(Math.random() * styleResponses.length)];
            
            // 如果有世界书上下文，添加相关元素
            const worldbookMount = AppState.worldbookMounts[AppState.currentChat.id];
            if (worldbookMount && worldbookMount.enabled && worldbookMount.worldbookId) {
                const worldbook = AppState.worldbooks.find(w => w.id === worldbookMount.worldbookId);
                if (worldbook) {
                    // 根据世界书类型添加不同的元素
                    if (worldbook.category === '奇幻') {
                        const fantasyElements = ['魔法', '咒语', '巨龙', '精灵', '巫师', '冒险'];
                        const element = fantasyElements[Math.floor(Math.random() * fantasyElements.length)];
                        response += ` 在这个${worldbook.name}中，${element}总是让人着迷。`;
                    } else if (worldbook.category === '科幻') {
                        const scifiElements = ['星际旅行', '人工智能', '未来科技', '外星文明', '时间旅行'];
                        const element = scifiElements[Math.floor(Math.random() * scifiElements.length)];
                        response += ` 这让我想起了${worldbook.name}中的${element}。`;
                    }
                }
            }
            
            // 如果启用了情感表达，添加情感词
            if (AppState.userSettings.enableEmotions) {
                const emotions = ['开心', '好奇', '兴奋', '思考', '感兴趣'];
                const emotion = emotions[Math.floor(Math.random() * emotions.length)];
                response += ` （我感到有些${emotion}）`;
            }
            
            return response;
        }
        
        // 生成AI日记
        function generateAI Diary(characterId, conversationContext) {
            const character = AppState.characters.find(c => c.id === characterId);
            if (!character) return;
            
            // 模拟生成日记内容
            const today = new Date();
            const diaryTemplates = [
                `今天是${today.getMonth() + 1}月${today.getDate()}日。${conversationContext ? '今天和用户聊到了有趣的话题。' : '今天又是平凡的一天。'}作为${character.name}，我${character.personality ? character.personality.split('，')[0] : '继续学习和成长'}。`,
                `记录今日：${conversationContext ? '与用户的对话让我思考了许多。' : '平静的一天过去了。'}${character.background ? '回想起我的背景：' + character.background.split('。')[0] + '。' : ''}`,
                `${today.toLocaleDateString('zh-CN')} 天气：晴。${conversationContext ? '今天的交流很有意义。' : ''}${character.likes ? '我喜欢' + character.likes.split('，')[0] + '，' : ''}这让我感到充实。`
            ];
            
            const diaryTitle = `日记：${today.getMonth() + 1}月${today.getDate()}日`;
            const diaryContent = diaryTemplates[Math.floor(Math.random() * diaryTemplates.length)];
            
            const newDiaryId = AppState.diaries.length > 0 ? Math.max(...AppState.diaries.map(d => d.id)) + 1 : 1;
            
            const newDiary = {
                id: newDiaryId,
                characterId: characterId,
                characterName: character.name,
                title: diaryTitle,
                content: diaryContent,
                date: today.toISOString(),
                mood: ['平静', '思考', '愉快', '充实'][Math.floor(Math.random() * 4)],
                tags: ['日常', '对话记录']
            };
            
            AppState.diaries.push(newDiary);
            saveDataToLocalStorage('diaries');
            
            // 如果当前在日记页面，重新渲染
            if (AppState.currentPage === 'diary') {
                renderDiaries();
            }
        }
        
        // 打开聊天背景设置对话框
        function openChatBgModal() {
            const chatBgModal = document.getElementById('chatBgModal');
            const chatBgOpacity = document.getElementById('chatBgOpacity');
            const opacityValue = document.getElementById('opacityValue');
            
            // 获取当前聊天背景设置
            const chatId = AppState.currentChat?.id;
            const chatBg = chatId ? AppState.chatBackgrounds[chatId] : { type: 'none', opacity: 0.15 };
            
            // 设置当前值
            chatBgOpacity.value = chatBg.opacity || 0.15;
            opacityValue.textContent = `${Math.round(chatBgOpacity.value * 100)}%`;
            
            // 显示对话框
            chatBgModal.classList.add('active');
            
            // 添加上传背景按钮事件
            document.getElementById('uploadChatBgBtn').addEventListener('click', function() {
                document.getElementById('chatBgFile').click();
            });
            
            // 添加背景图片链接按钮事件
            document.getElementById('chatBgUrlBtn').addEventListener('click', function() {
                document.getElementById('chatBgUrlGroup').style.display = 'block';
            });
            
            // 添加预设背景点击事件
            document.querySelectorAll('.bg-preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    const bgValue = this.getAttribute('data-bg');
                    document.getElementById('chatRoomBg').style.background = bgValue;
                    document.getElementById('chatRoomBg').style.backgroundImage = '';
                });
            });
            
            // 添加背景文件选择事件
            document.getElementById('chatBgFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('chatRoomBg').style.backgroundImage = `url('${e.target.result}')`;
                    document.getElementById('chatRoomBg').style.background = '';
                };
                reader.readAsDataURL(file);
            });
            
            // 添加保存按钮事件
            document.getElementById('saveChatBgBtn').onclick = function() {
                if (!AppState.currentChat) return;
                
                const chatId = AppState.currentChat.id;
                const bgValue = document.getElementById('chatRoomBg').style.background || 
                               document.getElementById('chatRoomBg').style.backgroundImage;
                const opacity = parseFloat(document.getElementById('chatBgOpacity').value);
                const bgUrl = document.getElementById('chatBgUrl').value.trim();
                
                let bgType = 'none';
                let value = '';
                
                if (bgUrl) {
                    bgType = 'image';
                    value = bgUrl;
                } else if (bgValue) {
                    if (bgValue.includes('url')) {
                        bgType = 'image';
                        value = bgValue.replace('url("', '').replace('")', '');
                    } else if (bgValue.includes('gradient')) {
                        bgType = 'gradient';
                        value = bgValue;
                    } else {
                        bgType = 'color';
                        value = bgValue;
                    }
                }
                
                if (bgType !== 'none') {
                    AppState.chatBackgrounds[chatId] = {
                        type: bgType,
                        value: value,
                        opacity: opacity
                    };
                    
                    saveDataToLocalStorage('chat_backgrounds');
                    alert('聊天背景已保存！');
                } else {
                    delete AppState.chatBackgrounds[chatId];
                    saveDataToLocalStorage('chat_backgrounds');
                    alert('已清除聊天背景！');
                }
                
                chatBgModal.classList.remove('active');
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelChatBgBtn').onclick = function() {
                chatBgModal.classList.remove('active');
                // 恢复原来的背景
                if (AppState.currentChat) {
                    const chatId = AppState.currentChat.id;
                    const chatBg = AppState.chatBackgrounds[chatId];
                    const chatRoomBg = document.getElementById('chatRoomBg');
                    
                    if (chatBg) {
                        if (chatBg.type === 'color' || chatBg.type === 'gradient') {
                            chatRoomBg.style.background = chatBg.value;
                            chatRoomBg.style.backgroundImage = '';
                        } else if (chatBg.type === 'image') {
                            chatRoomBg.style.backgroundImage = `url('${chatBg.value}')`;
                            chatRoomBg.style.background = '';
                        }
                        chatRoomBg.style.opacity = chatBg.opacity || 0.15;
                    }
                }
            };
        }
        
        // 打开世界书挂载对话框
        function openWorldbookMountModal() {
            const worldbookMountModal = document.getElementById('worldbookMountModal');
            const worldbookMountList = document.getElementById('worldbookMountList');
            
            // 清空列表
            worldbookMountList.innerHTML = '';
            
            // 获取当前聊天ID
            const chatId = AppState.currentChat?.id;
            if (!chatId) return;
            
            // 获取当前挂载的世界书
            const currentMount = AppState.worldbookMounts[chatId];
            
            // 添加世界书选项
            AppState.worldbooks.forEach(worldbook => {
                const worldbookItem = document.createElement('div');
                worldbookItem.className = 'chat-item';
                worldbookItem.style.cursor = 'pointer';
                worldbookItem.style.marginBottom = '10px';
                
                const isSelected = currentMount && currentMount.worldbookId === worldbook.id;
                
                worldbookItem.innerHTML = `
                    <div style="flex: 1; padding: 10px;">
                        <div style="font-weight: 500; margin-bottom: 5px;">${worldbook.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${worldbook.category} · ${worldbook.description.substring(0, 50)}...</div>
                    </div>
                    <div style="margin-right: 10px;">
                        ${isSelected ? 
                            '<i class="fas fa-check-circle" style="color: var(--primary-color); font-size: 1.2rem;"></i>' : 
                            '<i class="far fa-circle" style="color: var(--text-light); font-size: 1.2rem;"></i>'
                        }
                    </div>
                `;
                
                worldbookItem.addEventListener('click', function() {
                    // 清除所有选择
                    worldbookMountList.querySelectorAll('.chat-item').forEach(item => {
                        item.querySelector('i').className = 'far fa-circle';
                        item.querySelector('i').style.color = 'var(--text-light)';
                    });
                    
                    // 选择当前项
                    this.querySelector('i').className = 'fas fa-check-circle';
                    this.querySelector('i').style.color = 'var(--primary-color)';
                    
                    // 更新表单中的选择
                    document.querySelector(`input[name="mountStatus"][value="${currentMount && currentMount.enabled ? 'enabled' : 'disabled'}"]`).checked = true;
                });
                
                worldbookMountList.appendChild(worldbookItem);
            });
            
            // 设置当前挂载状态
            if (currentMount) {
                const statusRadio = document.querySelector(`input[name="mountStatus"][value="${currentMount.enabled ? 'enabled' : 'disabled'}"]`);
                if (statusRadio) {
                    statusRadio.checked = true;
                }
            }
            
            // 显示对话框
            worldbookMountModal.classList.add('active');
            
            // 添加保存按钮事件
            document.getElementById('saveWorldbookMountBtn').onclick = function() {
                const chatId = AppState.currentChat?.id;
                if (!chatId) return;
                
                // 获取选中的世界书
                const selectedItem = worldbookMountList.querySelector('.fa-check-circle');
                let worldbookId = null;
                
                if (selectedItem) {
                    const worldbookItem = selectedItem.closest('.chat-item');
                    const worldbookName = worldbookItem.querySelector('div:first-child div:first-child').textContent;
                    const worldbook = AppState.worldbooks.find(w => w.name === worldbookName);
                    if (worldbook) {
                        worldbookId = worldbook.id;
                    }
                }
                
                // 获取挂载状态
                const mountStatus = document.querySelector('input[name="mountStatus"]:checked').value;
                const enabled = mountStatus === 'enabled';
                
                if (worldbookId) {
                    AppState.worldbookMounts[chatId] = {
                        worldbookId: worldbookId,
                        enabled: enabled
                    };
                } else {
                    delete AppState.worldbookMounts[chatId];
                }
                
                saveDataToLocalStorage('worldbook_mounts');
                worldbookMountModal.classList.remove('active');
                
                // 更新聊天室中的指示器
                updateWorldbookIndicator();
                
                alert('世界书挂载设置已保存！');
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelWorldbookMountBtn').onclick = function() {
                worldbookMountModal.classList.remove('active');
            };
        }
        
        // 更新世界书指示器
        function updateWorldbookIndicator() {
            const chatId = AppState.currentChat?.id;
            if (!chatId) return;
            
            const worldbookMount = AppState.worldbookMounts[chatId];
            const indicator = document.getElementById('worldbookIndicator');
            
            if (worldbookMount && worldbookMount.enabled && worldbookMount.worldbookId) {
                const worldbook = AppState.worldbooks.find(w => w.id === worldbookMount.worldbookId);
                if (worldbook) {
                    indicator.querySelector('#currentWorldbookName').textContent = worldbook.name;
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            } else {
                indicator.classList.add('hidden');
            }
        }
        
        // 导出聊天记录
        function exportChatHistory(chat) {
            const chatData = {
                chatInfo: {
                    id: chat.id,
                    name: chat.name,
                    type: chat.type,
                    createdAt: chat.createdAt
                },
                messages: chat.messages,
                characters: AppState.characters.filter(c => chat.members.includes(c.id)),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(chatData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileName = `rynx-chat-${chat.name}-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
            
            alert('聊天记录已导出为JSON文件');
        }
        
        // 渲染朋友圈
        function renderMoments() {
            const momentsList = document.getElementById('momentsList');
            momentsList.innerHTML = '';
            
            if (AppState.moments.length === 0) {
                momentsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-newspaper" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>暂无动态</h3>
                        <p>点击"发表"按钮分享你的第一条动态</p>
                    </div>
                `;
                return;
            }
            
            // 按时间倒序排序
            const sortedMoments = [...AppState.moments].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedMoments.forEach(moment => {
                // 检查可见性
                if (moment.visibility === 'private' && moment.authorId !== 'user') {
                    return; // 跳过非用户私密动态
                }
                
                const momentCard = document.createElement('div');
                momentCard.className = 'moment-card';
                momentCard.setAttribute('data-moment-id', moment.id);
                
                // 格式化时间
                const momentTime = new Date(moment.timestamp);
                const now = new Date();
                const diffMs = now - momentTime;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                let timeText;
                if (diffHours < 1) {
                    timeText = '刚刚';
                } else if (diffHours < 24) {
                    timeText = `${diffHours}小时前`;
                } else if (diffDays === 1) {
                    timeText = '昨天';
                } else if (diffDays < 7) {
                    timeText = `${diffDays}天前`;
                } else {
                    timeText = momentTime.toLocaleDateString();
                }
                
                // 构建图片HTML
                let imagesHtml = '';
                if (moment.images && moment.images.length > 0) {
                    imagesHtml = `
                        <div class="moment-images">
                            ${moment.images.slice(0, 9).map((img, index) => `
                                <img src="${img}" class="moment-image" alt="图片${index + 1}" data-index="${index}">
                            `).join('')}
                        </div>
                    `;
                }
                
                // 构建评论HTML
                let commentsHtml = '';
                if (moment.comments && moment.comments.length > 0) {
                    commentsHtml = `
                        <div class="moment-comments">
                            ${moment.comments.map(comment => `
                                <div class="comment">
                                    <div class="comment-avatar">
                                        ${comment.authorId === 'user' ? 
                                            `<div style="width: 100%; height: 100%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold;">${AppState.userSettings.name.charAt(0)}</div>` :
                                            `<div style="width: 100%; height: 100%; background-color: #4a90e2; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${comment.authorName.charAt(0)}</div>`
                                        }
                                    </div>
                                    <div class="comment-content">
                                        <span class="comment-author">${comment.authorName}</span>
                                        ${comment.content}
                                    </div>
                                </div>
                            `).join('')}
                            <div class="comment-input-area">
                                <input type="text" class="comment-input" placeholder="评论..." data-moment-id="${moment.id}">
                                <button class="comment-send-btn" data-moment-id="${moment.id}">发送</button>
                            </div>
                        </div>
                    `;
                } else {
                    commentsHtml = `
                        <div class="moment-comments">
                            <div class="comment-input-area">
                                <input type="text" class="comment-input" placeholder="评论..." data-moment-id="${moment.id}">
                                <button class="comment-send-btn" data-moment-id="${moment.id}">发送</button>
                            </div>
                        </div>
                    `;
                }
                
                // 获取头像框
                let avatarFrame = '';
                if (AppState.userSettings.avatarFrame !== 'none') {
                    avatarFrame = getAvatarFrameHTML();
                }
                
                momentCard.innerHTML = `
                    <div class="moment-header">
                        <div class="moment-avatar">
                            ${moment.authorId === 'user' ? 
                                `<div style="width: 100%; height: 100%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold;">${AppState.userSettings.name.charAt(0)}</div>` :
                                (moment.authorId.startsWith('ai_') ? 
                                    `<div style="width: 100%; height: 100%; background-color: #4a90e2; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${moment.authorName.charAt(0)}</div>` :
                                    `<div style="width: 100%; height: 100%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold;">${moment.authorName.charAt(0)}</div>`
                                )
                            }
                            ${avatarFrame}
                        </div>
                        <div class="moment-author">
                            <div class="moment-author-name">${moment.authorName}</div>
                            <div class="moment-time">${timeText} ${moment.visibility === 'private' ? '· 私密' : moment.visibility === 'friends' ? '· 仅好友' : ''}</div>
                        </div>
                    </div>
                    
                    <div class="moment-content">${moment.content}</div>
                    
                    ${imagesHtml}
                    
                    <div class="moment-actions">
                        <div class="moment-action ${moment.likes && moment.likes.includes('用户') ? 'active' : ''}" data-moment-id="${moment.id}" data-action="like">
                            <i class="${moment.likes && moment.likes.includes('用户') ? 'fas' : 'far'} fa-heart"></i>
                            <span>${moment.likes ? moment.likes.length : 0}</span>
                        </div>
                        <div class="moment-action" data-moment-id="${moment.id}" data-action="comment-toggle">
                            <i class="far fa-comment"></i>
                            <span>${moment.comments ? moment.comments.length : 0}</span>
                        </div>
                        <div class="moment-action" data-moment-id="${moment.id}" data-action="share">
                            <i class="fas fa-share"></i>
                            <span>分享</span>
                        </div>
                    </div>
                    
                    ${commentsHtml}
                `;
                
                momentsList.appendChild(momentCard);
            });
            
            // 添加互动事件
            momentsList.querySelectorAll('.moment-action').forEach(action => {
                action.addEventListener('click', function() {
                    const momentId = parseInt(this.getAttribute('data-moment-id'));
                    const actionType = this.getAttribute('data-action');
                    
                    const moment = AppState.moments.find(m => m.id === momentId);
                    if (!moment) return;
                    
                    if (actionType === 'like') {
                        // 点赞/取消点赞
                        if (!moment.likes) moment.likes = [];
                        
                        const heartIcon = this.querySelector('i');
                        const likeCount = this.querySelector('span');
                        
                        if (heartIcon.classList.contains('far')) {
                            // 点赞
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas');
                            heartIcon.style.color = 'var(--danger-color)';
                            moment.likes.push('用户');
                            this.classList.add('active');
                        } else {
                            // 取消点赞
                            heartIcon.classList.remove('fas');
                            heartIcon.classList.add('far');
                            heartIcon.style.color = '';
                            moment.likes = moment.likes.filter(name => name !== '用户');
                            this.classList.remove('active');
                        }
                        
                        likeCount.textContent = moment.likes.length;
                        saveDataToLocalStorage('moments');
                    } else if (actionType === 'comment-toggle') {
                        // 展开/收起评论
                        const commentSection = this.closest('.moment-card').querySelector('.moment-comments');
                        commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
                    } else if (actionType === 'share') {
                        // 分享
                        alert('已复制分享链接到剪贴板');
                        // 实际应用中这里应该是复制链接到剪贴板
                    }
                });
            });
            
            // 添加评论发送事件
            momentsList.querySelectorAll('.comment-send-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const momentId = parseInt(this.getAttribute('data-moment-id'));
                    const commentInput = this.previousElementSibling;
                    const comment = commentInput.value.trim();
                    
                    if (!comment) return;
                    
                    const moment = AppState.moments.find(m => m.id === momentId);
                    if (!moment) return;
                    
                    if (!moment.comments) moment.comments = [];
                    
                    const newComment = {
                        id: moment.comments.length + 1,
                        authorId: 'user',
                        authorName: AppState.userSettings.name,
                        content: comment,
                        timestamp: new Date().toISOString()
                    };
                    
                    moment.comments.push(newComment);
                    saveDataToLocalStorage('moments');
                    
                    // 清空输入框
                    commentInput.value = '';
                    
                    // 重新渲染朋友圈
                    renderMoments();
                });
            });
            
            // 评论输入框回车发送
            momentsList.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const momentId = parseInt(this.getAttribute('data-moment-id'));
                        const comment = this.value.trim();
                        
                        if (!comment) return;
                        
                        const moment = AppState.moments.find(m => m.id === momentId);
                        if (!moment) return;
                        
                        if (!moment.comments) moment.comments = [];
                        
                        const newComment = {
                            id: moment.comments.length + 1,
                            authorId: 'user',
                            authorName: AppState.userSettings.name,
                            content: comment,
                            timestamp: new Date().toISOString()
                        };
                        
                        moment.comments.push(newComment);
                        saveDataToLocalStorage('moments');
                        
                        // 清空输入框
                        this.value = '';
                        
                        // 重新渲染朋友圈
                        renderMoments();
                    }
                });
            });
        }
        
        // 打开发表朋友圈对话框
        function openNewMomentModal() {
            const newMomentModal = document.getElementById('newMomentModal');
            const specificUsersGroup = document.getElementById('specificUsersGroup');
            
            // 清空预览
            document.getElementById('momentImagesPreview').innerHTML = '';
            
            // 重置表单
            document.getElementById('momentContent').value = '';
            document.getElementById('momentVisibility').value = 'public';
            document.getElementById('momentSchedule').value = '';
            
            // 可见范围变化事件
            document.getElementById('momentVisibility').addEventListener('change', function() {
                if (this.value === 'specific') {
                    specificUsersGroup.style.display = 'block';
                    renderSpecificUsersList();
                } else {
                    specificUsersGroup.style.display = 'none';
                }
            });
            
            // 显示对话框
            newMomentModal.classList.add('active');
            
            // 添加本地图片按钮事件
            document.getElementById('addMomentImageBtn').addEventListener('click', function() {
                document.getElementById('momentImageInput').click();
            });
            
            // 添加图片链接按钮事件
            document.getElementById('addMomentImageUrlBtn').addEventListener('click', function() {
                openImageUrlModal();
            });
            
            // 图片选择事件
            document.getElementById('momentImageInput').addEventListener('change', function(e) {
                const files = e.target.files;
                const previewContainer = document.getElementById('momentImagesPreview');
                
                // 清空预览
                previewContainer.innerHTML = '';
                
                // 限制最多9张图片
                const maxImages = Math.min(files.length, 9);
                
                for (let i = 0; i < maxImages; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imgPreview = document.createElement('div');
                        imgPreview.style.position = 'relative';
                        imgPreview.innerHTML = `
                            <img src="${e.target.result}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 5px;">
                            <button class="header-btn" style="position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; font-size: 0.8rem; background-color: rgba(0,0,0,0.5); color: white;" data-index="${i}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        previewContainer.appendChild(imgPreview);
                        
                        // 添加删除按钮事件
                        imgPreview.querySelector('button').addEventListener('click', function() {
                            imgPreview.remove();
                        });
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // 添加发表按钮事件
            document.getElementById('publishMomentBtn').onclick = function() {
                const content = document.getElementById('momentContent').value.trim();
                const visibility = document.getElementById('momentVisibility').value;
                const schedule = document.getElementById('momentSchedule').value;
                
                if (!content) {
                    alert('请填写动态内容');
                    return;
                }
                
                // 收集图片
                const images = [];
                document.querySelectorAll('#momentImagesPreview img').forEach(img => {
                    images.push(img.src);
                });
                
                // 收集指定可见用户
                let specificUsers = [];
                if (visibility === 'specific') {
                    const selectedUsers = document.querySelectorAll('#specificUsersList input[type="checkbox"]:checked');
                    selectedUsers.forEach(checkbox => {
                        specificUsers.push(checkbox.value);
                    });
                }
                
                // 创建新动态ID
                const newMomentId = AppState.moments.length > 0 ? Math.max(...AppState.moments.map(m => m.id)) + 1 : 1;
                
                const newMoment = {
                    id: newMomentId,
                    authorId: 'user',
                    authorName: AppState.userSettings.name,
                    content: content,
                    images: images,
                    likes: [],
                    comments: [],
                    timestamp: schedule ? new Date(schedule).toISOString() : new Date().toISOString(),
                    visibility: visibility,
                    specificUsers: specificUsers
                };
                
                AppState.moments.push(newMoment);
                saveDataToLocalStorage('moments');
                
                // 关闭对话框
                newMomentModal.classList.remove('active');
                
                // 重新渲染朋友圈
                renderMoments();
                
                alert(schedule ? `动态已定时，将在${new Date(schedule).toLocaleString()}发布` : '动态发表成功！');
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelMomentBtn').onclick = function() {
                newMomentModal.classList.remove('active');
            };
        }
        
        // 渲染指定可见用户列表
        function renderSpecificUsersList() {
            const specificUsersList = document.getElementById('specificUsersList');
            specificUsersList.innerHTML = '';
            
            // 添加AI角色
            AppState.characters.forEach(character => {
                const userItem = document.createElement('div');
                userItem.style.display = 'flex';
                userItem.style.alignItems = 'center';
                userItem.style.gap = '10px';
                userItem.style.padding = '8px';
                userItem.style.borderBottom = '1px solid var(--border-color)';
                
                userItem.innerHTML = `
                    <input type="checkbox" value="${character.id}">
                    <div style="width: 30px; height: 30px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
                        ${character.avatar ? 
                            `<img src="${character.avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            `<div style="width: 100%; height: 100%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold;">${character.name.charAt(0)}</div>`
                        }
                    </div>
                    <div>${character.name}</div>
                `;
                
                specificUsersList.appendChild(userItem);
            });
        }
        
        // 打开图片链接对话框
        function openImageUrlModal() {
            const imageUrlModal = document.getElementById('imageUrlModal');
            
            // 清空输入框和预览
            document.getElementById('imageUrlInput').value = '';
            document.getElementById('imageUrlPreview').innerHTML = '预览';
            document.getElementById('imageUrlPreview').style.backgroundImage = '';
            
            // 显示对话框
            imageUrlModal.classList.add('active');
            
            // 添加预览功能
            document.getElementById('imageUrlInput').addEventListener('input', function() {
                const url = this.value.trim();
                if (url) {
                    document.getElementById('imageUrlPreview').style.backgroundImage = `url('${url}')`;
                    document.getElementById('imageUrlPreview').style.backgroundSize = 'cover';
                    document.getElementById('imageUrlPreview').style.backgroundPosition = 'center';
                    document.getElementById('imageUrlPreview').innerHTML = '';
                } else {
                    document.getElementById('imageUrlPreview').style.backgroundImage = '';
                    document.getElementById('imageUrlPreview').innerHTML = '预览';
                }
            });
            
            // 添加确认按钮事件
            document.getElementById('confirmImageUrlBtn').onclick = function() {
                const imageUrl = document.getElementById('imageUrlInput').value.trim();
                
                if (!imageUrl) {
                    alert('请输入图片链接');
                    return;
                }
                
                // 添加图片到朋友圈预览
                const previewContainer = document.getElementById('momentImagesPreview');
                const imgPreview = document.createElement('div');
                imgPreview.style.position = 'relative';
                imgPreview.innerHTML = `
                    <img src="${imageUrl}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 5px;">
                    <button class="header-btn" style="position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; font-size: 0.8rem; background-color: rgba(0,0,0,0.5); color: white;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                previewContainer.appendChild(imgPreview);
                
                // 添加删除按钮事件
                imgPreview.querySelector('button').addEventListener('click', function() {
                    imgPreview.remove();
                });
                
                // 关闭对话框
                imageUrlModal.classList.remove('active');
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelImageUrlBtn').onclick = function() {
                imageUrlModal.classList.remove('active');
            };
        }
        
        // 渲染世界书分类
        function renderWorldbookCategories() {
            const worldbookCategories = document.getElementById('worldbookCategories');
            worldbookCategories.innerHTML = '';
            
            // 添加"全部"分类
            const allTab = document.createElement('div');
            allTab.className = `category-tab ${AppState.currentWorldbookCategory === '全部' ? 'active' : ''}`;
            allTab.textContent = '全部';
            allTab.addEventListener('click', function() {
                AppState.currentWorldbookCategory = '全部';
                renderWorldbookCategories();
                renderWorldbooks();
            });
            worldbookCategories.appendChild(allTab);
            
            // 添加各个分类
            AppState.worldbookCategories.forEach(category => {
                const categoryTab = document.createElement('div');
                categoryTab.className = `category-tab ${AppState.currentWorldbookCategory === category ? 'active' : ''}`;
                categoryTab.textContent = category;
                categoryTab.addEventListener('click', function() {
                    AppState.currentWorldbookCategory = category;
                    renderWorldbookCategories();
                    renderWorldbooks();
                });
                worldbookCategories.appendChild(categoryTab);
            });
            
            // 添加"新增分类"按钮
            const addTab = document.createElement('div');
            addTab.className = 'category-tab add-category';
            addTab.innerHTML = '<i class="fas fa-plus"></i> 新增';
            addTab.addEventListener('click', function() {
                const categoryName = prompt('请输入新分类名称:');
                if (categoryName && categoryName.trim()) {
                    if (!AppState.worldbookCategories.includes(categoryName.trim())) {
                        AppState.worldbookCategories.push(categoryName.trim());
                        saveDataToLocalStorage('worldbook_categories');
                        renderWorldbookCategories();
                        renderWorldbookCategoryOptions();
                    } else {
                        alert('该分类已存在!');
                    }
                }
            });
            worldbookCategories.appendChild(addTab);
        }
        
        // 渲染世界书分类选项
        function renderWorldbookCategoryOptions() {
            const worldCategorySelect = document.getElementById('worldCategory');
            worldCategorySelect.innerHTML = '';
            
            AppState.worldbookCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                worldCategorySelect.appendChild(option);
            });
        }
        
        // 渲染世界书
        function renderWorldbooks() {
            const worldbookList = document.getElementById('worldbookList');
            worldbookList.innerHTML = '';
            
            // 过滤世界书
            let filteredWorldbooks = AppState.worldbooks;
            if (AppState.currentWorldbookCategory !== '全部') {
                filteredWorldbooks = AppState.worldbooks.filter(w => w.category === AppState.currentWorldbookCategory);
            }
            
            if (filteredWorldbooks.length === 0) {
                worldbookList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary); grid-column: 1 / -1;">
                        <i class="fas fa-globe" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>暂无世界书</h3>
                        <p>${AppState.currentWorldbookCategory !== '全部' ? `在"${AppState.currentWorldbookCategory}"分类中` : ''}创建一个新世界来开始你的冒险</p>
                    </div>
                `;
                return;
            }
            
            filteredWorldbooks.forEach(world => {
                const worldCard = document.createElement('div');
                worldCard.className = 'worldbook-card';
                
                // 格式化创建时间
                const createdDate = new Date(world.createdAt);
                const formattedDate = createdDate.toLocaleDateString();
                
                worldCard.innerHTML = `
                    <div class="worldbook-category">${world.category}</div>
                    <div class="worldbook-title">${world.name}</div>
                    <div class="worldbook-description">${world.description}</div>
                    
                    ${world.rules ? `
                        <div class="character-section">
                            <div class="character-section-title">世界规则</div>
                            <div class="character-section-content">${world.rules.length > 100 ? world.rules.substring(0, 100) + '...' : world.rules}</div>
                        </div>
                    ` : ''}
                    
                    ${world.lore ? `
                        <div class="character-section">
                            <div class="character-section-title">世界背景</div>
                            <div class="character-section-content">${world.lore.length > 100 ? world.lore.substring(0, 100) + '...' : world.lore}</div>
                        </div>
                    ` : ''}
                    
                    <div class="worldbook-meta">创建于: ${formattedDate}</div>
                `;
                
                worldbookList.appendChild(worldCard);
            });
        }
        
        // 创建世界书
        function createWorldbook() {
            const name = document.getElementById('worldName').value.trim();
            const category = document.getElementById('worldCategory').value;
            const description = document.getElementById('worldDescription').value.trim();
            const rules = document.getElementById('worldRules').value.trim();
            const lore = document.getElementById('worldLore').value.trim();
            
            if (!name) {
                alert('请输入世界名称');
                return;
            }
            
            if (!category) {
                alert('请选择分类');
                return;
            }
            
            const newWorldId = AppState.worldbooks.length > 0 ? Math.max(...AppState.worldbooks.map(w => w.id)) + 1 : 1;
            
            const newWorld = {
                id: newWorldId,
                name: name,
                category: category,
                description: description,
                rules: rules,
                lore: lore,
                createdAt: new Date().toISOString()
            };
            
            AppState.worldbooks.push(newWorld);
            saveDataToLocalStorage('worldbooks');
            
            // 重新渲染世界书列表
            renderWorldbooks();
            
            // 清空表单
            document.getElementById('worldName').value = '';
            document.getElementById('worldDescription').value = '';
            document.getElementById('worldRules').value = '';
            document.getElementById('worldLore').value = '';
            
            alert('世界创建成功！');
        }
        
        // 渲染API预设
        function renderApiPresets() {
            const apiPresetsContainer = document.getElementById('apiPresets');
            apiPresetsContainer.innerHTML = '';
            
            AppState.apiPresets.forEach(preset => {
                const presetCard = document.createElement('div');
                presetCard.className = 'api-preset-card';
                if (AppState.currentApiPreset && preset.id === AppState.currentApiPreset.id) {
                    presetCard.classList.add('active');
                }
                presetCard.setAttribute('data-preset-id', preset.id);
                
                presetCard.innerHTML = `
                    <div class="api-preset-name">${preset.name}</div>
                    <div class="api-preset-provider">${getProviderName(preset.provider)}</div>
                    <div class="api-preset-status">
                        ${preset.key ? 
                            '<span style="color: var(--primary-color);">已配置密钥</span>' : 
                            '<span style="color: var(--danger-color);">未配置密钥</span>'
                        }
                    </div>
                `;
                
                presetCard.addEventListener('click', function() {
                    // 更新选中状态
                    document.querySelectorAll('.api-preset-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 加载预设到表单
                    loadPresetToForm(preset);
                    
                    // 更新当前预设
                    AppState.currentApiPreset = preset;
                });
                
                apiPresetsContainer.appendChild(presetCard);
            });
            
            // 加载当前预设到表单
            if (AppState.currentApiPreset) {
                loadPresetToForm(AppState.currentApiPreset);
            }
        }
        
        // 获取提供商名称
        function getProviderName(provider) {
            const providers = {
                'openai': 'OpenAI',
                'anthropic': 'Anthropic Claude',
                'google': 'Google Gemini',
                'custom': '自定义'
            };
            return providers[provider] || provider;
        }
        
        // 加载预设到表单
        function loadPresetToForm(preset) {
            document.getElementById('apiConfigName').value = preset.name;
            document.getElementById('apiProvider').value = preset.provider;
            document.getElementById('apiUrl').value = preset.url;
            document.getElementById('apiKey').value = preset.key;
            document.getElementById('apiModel').value = preset.model;
        }
        
        // 保存API配置
        function saveApiConfig() {
            const name = document.getElementById('apiConfigName').value.trim();
            const provider = document.getElementById('apiProvider').value;
            const url = document.getElementById('apiUrl').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('apiModel').value.trim();
            
            if (!name || !url) {
                alert('请填写配置名称和API地址');
                return;
            }
            
            let presetId;
            
            // 检查是否正在编辑现有预设
            if (AppState.currentApiPreset) {
                presetId = AppState.currentApiPreset.id;
                
                // 更新现有预设
                const index = AppState.apiPresets.findIndex(p => p.id === presetId);
                if (index !== -1) {
                    AppState.apiPresets[index] = {
                        ...AppState.apiPresets[index],
                        name,
                        provider,
                        url,
                        key,
                        model
                    };
                    
                    AppState.currentApiPreset = AppState.apiPresets[index];
                }
            } else {
                // 创建新预设
                presetId = AppState.apiPresets.length > 0 ? Math.max(...AppState.apiPresets.map(p => p.id)) + 1 : 1;
                
                const newPreset = {
                    id: presetId,
                    name,
                    provider,
                    url,
                    key,
                    model
                };
                
                AppState.apiPresets.push(newPreset);
                AppState.currentApiPreset = newPreset;
            }
            
            saveDataToLocalStorage('apiPresets');
            renderApiPresets();
            alert('API配置已保存！');
        }
        
        // 测试API连接
        function testApiConnection() {
            const key = document.getElementById('apiKey').value.trim();
            const url = document.getElementById('apiUrl').value.trim();
            
            if (!key || !url) {
                alert('请填写API密钥和地址');
                return;
            }
            
            const testResult = document.getElementById('apiTestResult');
            testResult.className = 'api-test-result';
            testResult.style.display = 'block';
            
            // 显示测试中
            testResult.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(7, 193, 96, 0.3); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s ease-in-out infinite;"></div>
                    <span>正在测试API连接...</span>
                </div>
            `;
            
            // 模拟API测试
            setTimeout(() => {
                const isSuccess = Math.random() > 0.3; // 70%成功率
                
                if (isSuccess) {
                    testResult.className = 'api-test-result api-test-success';
                    testResult.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-check-circle" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>连接成功！</strong>
                                <p style="margin-top: 5px; color: inherit;">API配置有效，可以正常使用。</p>
                            </div>
                        </div>
                    `;
                } else {
                    testResult.className = 'api-test-result api-test-error';
                    testResult.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-times-circle" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>连接失败</strong>
                                <p style="margin-top: 5px; color: inherit;">请检查API密钥、地址和网络连接。</p>
                            </div>
                        </div>
                    `;
                }
            }, 1500);
        }
        
        // 渲染人设列表
        function renderCharacters() {
            const characterList = document.getElementById('characterList');
            characterList.innerHTML = '';
            
            if (AppState.characters.length === 0) {
                characterList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary); grid-column: 1 / -1;">
                        <i class="fas fa-user-astronaut" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>暂无人设</h3>
                        <p>创建你的第一个AI角色</p>
                    </div>
                `;
                return;
            }
            
            AppState.characters.forEach(character => {
                const characterCard = document.createElement('div');
                characterCard.className = 'character-card';
                characterCard.setAttribute('data-character-id', character.id);
                
                // 性别显示
                const genderMap = {
                    'male': '男',
                    'female': '女',
                    'other': '其他'
                };
                const genderText = genderMap[character.gender] || character.gender;
                
                // 获取头像框
                let avatarFrame = '';
                if (AppState.userSettings.avatarFrame !== 'none') {
                    avatarFrame = getAvatarFrameHTML();
                }
                
                characterCard.innerHTML = `
                    <div class="character-header">
                        <div class="character-avatar">
                            ${character.avatar ? 
                                `<img src="${character.avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                character.name.charAt(0)
                            }
                            ${avatarFrame}
                        </div>
                        <div>
                            <div class="character-name">${character.name}</div>
                            <div class="character-meta">${genderText} · ${character.age}岁</div>
                        </div>
                    </div>
                    
                    ${character.personality ? `
                        <div class="character-section">
                            <div class="character-section-title">性格特点</div>
                            <div class="character-section-content">${character.personality.length > 80 ? character.personality.substring(0, 80) + '...' : character.personality}</div>
                        </div>
                    ` : ''}
                    
                    ${character.background ? `
                        <div class="character-section">
                            <div class="character-section-title">背景故事</div>
                            <div class="character-section-content">${character.background.length > 100 ? character.background.substring(0, 100) + '...' : character.background}</div>
                        </div>
                    ` : ''}
                    
                    <div class="character-actions">
                        <button class="btn btn-primary btn-small chat-with-character-btn" data-character-id="${character.id}">
                            <i class="fas fa-comment"></i>
                            聊天
                        </button>
                        <button class="btn btn-danger btn-small delete-character-btn" data-character-id="${character.id}">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </div>
                `;
                
                characterList.appendChild(characterCard);
            });
            
            // 添加聊天按钮事件
            document.querySelectorAll('.chat-with-character-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const characterId = parseInt(this.getAttribute('data-character-id'));
                    startChatWithCharacter(characterId);
                });
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-character-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const characterId = parseInt(this.getAttribute('data-character-id'));
                    deleteCharacter(characterId);
                });
            });
        }
        
        // 创建人设
        function createCharacter() {
            const name = document.getElementById('charName').value.trim();
            const gender = document.getElementById('charGender').value;
            const age = parseInt(document.getElementById('charAge').value);
            const avatar = document.getElementById('charAvatar').value.trim();
            const personality = document.getElementById('charPersonality').value.trim();
            const background = document.getElementById('charBackground').value.trim();
            const likes = document.getElementById('charLikes').value.trim();
            const dislikes = document.getElementById('charDislikes').value.trim();
            const userPersonality = document.getElementById('userPersonality').value.trim();
            
            // 验证必填字段
            if (!name || !gender || !age) {
                alert('请填写姓名、性别和年龄（必填项）');
                return;
            }
            
            // 创建新人设ID
            const newId = AppState.characters.length > 0 ? Math.max(...AppState.characters.map(c => c.id)) + 1 : 1;
            
            const newCharacter = {
                id: newId,
                name,
                gender,
                age,
                avatar,
                personality,
                background,
                likes,
                dislikes,
                userPersonality,
                createdAt: new Date().toISOString()
            };
            
            AppState.characters.push(newCharacter);
            saveDataToLocalStorage('characters');
            renderCharacters();
            
            // 清空表单
            document.getElementById('charName').value = '';
            document.getElementById('charGender').value = '';
            document.getElementById('charAge').value = '';
            document.getElementById('charAvatar').value = '';
            document.getElementById('charPersonality').value = '';
            document.getElementById('charBackground').value = '';
            document.getElementById('charLikes').value = '';
            document.getElementById('charDislikes').value = '';
            document.getElementById('userPersonality').value = '';
            
            alert('人设创建成功！');
        }
        
        // 开始与角色聊天
        function startChatWithCharacter(characterId) {
            AppState.selectedAIs = [characterId];
            AppState.isGroupChat = false;
            createChat();
        }
        
        // 删除角色
        function deleteCharacter(characterId) {
            if (confirm('确定要删除这个人设吗？')) {
                AppState.characters = AppState.characters.filter(c => c.id !== characterId);
                saveDataToLocalStorage('characters');
                renderCharacters();
            }
        }
        
        // 渲染日记列表
        function renderDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';
            
            if (AppState.diaries.length === 0) {
                diaryList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-book" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>暂无日记</h3>
                        <p>AI角色的日记将在这里显示</p>
                    </div>
                `;
                return;
            }
            
            // 按时间倒序排序
            const sortedDiaries = [...AppState.diaries].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedDiaries.forEach(diary => {
                const diaryCard = document.createElement('div');
                diaryCard.className = 'diary-card';
                diaryCard.setAttribute('data-diary-id', diary.id);
                
                // 格式化日期
                const diaryDate = new Date(diary.date);
                const formattedDate = diaryDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // 预览内容
                let preview = diary.content;
                if (preview.length > 150) {
                    preview = preview.substring(0, 150) + '...';
                }
                
                diaryCard.innerHTML = `
                    <div class="diary-header">
                        <div class="diary-date">${formattedDate}</div>
                        <div class="diary-author">
                            <i class="fas fa-user"></i>
                            ${diary.characterName || '系统'}
                        </div>
                    </div>
                    <div class="diary-title">${diary.title}</div>
                    <div class="diary-content">${preview}</div>
                    <div class="diary-actions">
                        <button class="btn btn-primary btn-small view-diary-btn" data-diary-id="${diary.id}">
                            <i class="fas fa-eye"></i>
                            查看
                        </button>
                        <button class="btn btn-secondary btn-small regenerate-diary-btn" data-diary-id="${diary.id}">
                            <i class="fas fa-redo"></i>
                            重新生成
                        </button>
                    </div>
                `;
                
                diaryList.appendChild(diaryCard);
            });
            
            // 添加查看按钮事件
            document.querySelectorAll('.view-diary-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const diaryId = parseInt(this.getAttribute('data-diary-id'));
                    openDiaryDetail(diaryId);
                });
            });
            
            // 添加重新生成按钮事件
            document.querySelectorAll('.regenerate-diary-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const diaryId = parseInt(this.getAttribute('data-diary-id'));
                    regenerateDiary(diaryId);
                });
            });
        }
        
        // 打开日记详情
        function openDiaryDetail(diaryId) {
            const diary = AppState.diaries.find(d => d.id === diaryId);
            if (!diary) return;
            
            // 格式化日期
            const diaryDate = new Date(diary.date);
            const formattedDate = diaryDate.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const detailPage = document.getElementById('diaryDetailPage');
            detailPage.innerHTML = `
                <div class="diary-page">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" id="backFromDiaryBtn">
                            <i class="fas fa-arrow-left"></i>
                            返回
                        </button>
                    </div>
                    
                    <div class="diary-card">
                        <div class="diary-header">
                            <div class="diary-date">${formattedDate}</div>
                            <div class="diary-author">
                                <i class="fas fa-user"></i>
                                ${diary.characterName || '系统'}
                            </div>
                        </div>
                        <div class="diary-title" style="font-size: 1.5rem;">${diary.title}</div>
                        <div class="diary-content" style="-webkit-line-clamp: unset; overflow: visible;">
                            ${diary.content.split('\n').map(p => `<p style="margin-bottom: 15px;">${p}</p>`).join('')}
                        </div>
                        <div class="diary-actions">
                            <button class="btn btn-secondary" id="regenerateDiaryDetailBtn" data-diary-id="${diary.id}">
                                <i class="fas fa-redo"></i>
                                重新生成
                            </button>
                            <button class="btn btn-primary" id="saveDiaryBtn" data-diary-id="${diary.id}">
                                <i class="fas fa-save"></i>
                                保存副本
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 显示详情页
            pages.forEach(page => page.classList.remove('active'));
            detailPage.classList.add('active');
            
            // 更新标题
            headerTitle.innerHTML = `<i class="fas fa-book"></i><span>${diary.title}</span>`;
            
            // 添加返回按钮事件
            document.getElementById('backFromDiaryBtn').addEventListener('click', function() {
                showPage('diary');
                headerTitle.innerHTML = '<i class="fas fa-book"></i><span>AI日记</span>';
            });
            
            // 添加重新生成按钮事件
            document.getElementById('regenerateDiaryDetailBtn').addEventListener('click', function() {
                const diaryId = parseInt(this.getAttribute('data-diary-id'));
                regenerateDiary(diaryId);
                
                // 返回日记列表
                setTimeout(() => {
                    showPage('diary');
                    headerTitle.innerHTML = '<i class="fas fa-book"></i><span>AI日记</span>';
                }, 500);
            });
            
            // 添加保存按钮事件
            document.getElementById('saveDiaryBtn').addEventListener('click', function() {
                const diaryId = parseInt(this.getAttribute('data-diary-id'));
                const diary = AppState.diaries.find(d => d.id === diaryId);
                
                if (diary) {
                    // 创建副本
                    const diaryCopy = {
                        ...diary,
                        id: AppState.diaries.length > 0 ? Math.max(...AppState.diaries.map(d => d.id)) + 1 : 1,
                        date: new Date().toISOString(),
                        title: diary.title + ' (副本)'
                    };
                    
                    AppState.diaries.push(diaryCopy);
                    saveDataToLocalStorage('diaries');
                    alert('日记副本已保存！');
                    
                    // 返回日记列表
                    setTimeout(() => {
                        showPage('diary');
                        headerTitle.innerHTML = '<i class="fas fa-book"></i><span>AI日记</span>';
                    }, 500);
                }
            });
        }
        
        // 重新生成日记
        function regenerateDiary(diaryId) {
            const diary = AppState.diaries.find(d => d.id === diaryId);
            if (!diary) return;
            
            if (!confirm('确定要重新生成这篇日记吗？原内容将被替换。')) {
                return;
            }
            
            // 模拟重新生成日记（实际应调用API）
            const today = new Date();
            const newContent = `今天是${today.getMonth() + 1}月${today.getDate()}日。这是我重新生成的日记内容。${diary.characterName ? `作为${diary.characterName}，` : ''}我在今天重新思考了之前的对话和经历，有了新的感悟。我希望在未来能继续这样的学习和成长。`;
            
            diary.content = newContent;
            diary.date = today.toISOString();
            saveDataToLocalStorage('diaries');
            
            alert('日记已重新生成！');
            
            // 重新渲染日记列表
            renderDiaries();
        }
        
        // 渲染美化选项
        function renderBeautifyOptions() {
            // 字体选项
            const fontOptions = document.getElementById('fontOptions');
            fontOptions.innerHTML = '';
            
            const fonts = [
                { id: 'default', name: '默认字体', className: 'font-default' },
                { id: 'elegant', name: '优雅字体', className: 'font-elegant' },
                { id: 'cute', name: '可爱字体', className: 'font-cute' },
                { id: 'tech', name: '科技字体', className: 'font-tech' },
                { id: 'classic', name: '古典字体', className: 'font-classic' },
                { id: 'calligraphy', name: '书法字体', className: 'font-calligraphy' },
                { id: 'long', name: '龙藏字体', className: 'font-long' }
            ];
            
            fonts.forEach(font => {
                const fontOption = document.createElement('div');
                fontOption.className = `font-option ${AppState.userSettings.font === font.id ? 'active' : ''}`;
                fontOption.setAttribute('data-font-id', font.id);
                fontOption.textContent = font.name;
                fontOption.style.fontFamily = font.id === 'default' ? '' : font.className.split(' ')[0];
                
                fontOption.addEventListener('click', function() {
                    // 更新选中状态
                    document.querySelectorAll('.font-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 应用字体
                    AppState.userSettings.font = font.id;
                    document.body.className = font.className;
                    saveDataToLocalStorage('userSettings');
                });
                
                fontOptions.appendChild(fontOption);
            });
            
            // 自定义字体链接
            document.getElementById('customFontLink').value = AppState.userSettings.customFontLink || '';
            
            // 主题选项
            const themeOptions = document.getElementById('themeOptions');
            themeOptions.innerHTML = '';
            
            const themes = [
                { id: 'light', name: '浅色主题', className: 'theme-light' },
                { id: 'dark', name: '深色主题', className: 'theme-dark' },
                { id: 'blue', name: '蓝色主题', className: 'theme-blue' },
                { id: 'purple', name: '紫色主题', className: 'theme-purple' }
            ];
            
            themes.forEach(theme => {
                const themeOption = document.createElement('div');
                themeOption.className = `theme-option ${theme.className} ${AppState.userSettings.theme === theme.id ? 'active' : ''}`;
                themeOption.setAttribute('data-theme-id', theme.id);
                
                themeOption.innerHTML = `
                    <div class="theme-preview"></div>
                    <div class="theme-name">${theme.name}</div>
                `;
                
                themeOption.addEventListener('click', function() {
                    // 更新选中状态
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 应用主题
                    AppState.userSettings.theme = theme.id;
                    
                    if (theme.id === 'dark') {
                        document.body.classList.add('dark-mode');
                        document.getElementById('themeToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
                    } else {
                        document.body.classList.remove('dark-mode');
                        document.getElementById('themeToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
                    }
                    
                    saveDataToLocalStorage('userSettings');
                });
                
                themeOptions.appendChild(themeOption);
            });
            
            // 自定义头像框CSS
            document.getElementById('customAvatarFrameCSS').value = AppState.userSettings.customAvatarFrameCSS || '';
            
            // 自定义聊天框CSS
            document.getElementById('customChatBubbleCSS').value = AppState.userSettings.customChatBubbleCSS || '';
        }
        
        // 保存字体设置
        function saveFontSettings() {
            const customFontLink = document.getElementById('customFontLink').value.trim();
            
            AppState.userSettings.customFontLink = customFontLink;
            
            if (customFontLink) {
                loadCustomFont(customFontLink);
            }
            
            saveDataToLocalStorage('userSettings');
            alert('字体设置已保存！');
        }
        
        // 保存头像框设置
        function saveAvatarFrameSettings() {
            const customAvatarFrameCSS = document.getElementById('customAvatarFrameCSS').value.trim();
            
            AppState.userSettings.customAvatarFrameCSS = customAvatarFrameCSS;
            AppState.userSettings.avatarFrame = 'custom';
            
            // 应用自定义CSS
            if (customAvatarFrameCSS) {
                applyCustomCSS(customAvatarFrameCSS + '\n\n' + (AppState.userSettings.customChatBubbleCSS || ''));
            }
            
            // 更新头像框预览
            applyAvatarFrame('custom');
            
            saveDataToLocalStorage('userSettings');
            alert('头像框设置已保存！');
        }
        
        // 保存聊天框样式
        function saveChatBubbleSettings() {
            const customChatBubbleCSS = document.getElementById('customChatBubbleCSS').value.trim();
            
            AppState.userSettings.customChatBubbleCSS = customChatBubbleCSS;
            
            // 应用自定义CSS
            if (customChatBubbleCSS) {
                applyCustomCSS((AppState.userSettings.customAvatarFrameCSS || '') + '\n\n' + customChatBubbleCSS);
            }
            
            saveDataToLocalStorage('userSettings');
            alert('聊天框样式已保存！');
        }
        
        // 导出设置
        function exportSettings() {
            const settings = {
                userSettings: AppState.userSettings,
                characters: AppState.characters,
                worldbooks: AppState.worldbooks,
                worldbookCategories: AppState.worldbookCategories,
                apiPresets: AppState.apiPresets,
                worldbookMounts: AppState.worldbookMounts,
                chatBackgrounds: AppState.chatBackgrounds,
                customCSS: AppState.customCSS,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `rynx-settings-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('设置已导出为JSON文件');
        }
        
        // 导入设置
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const settings = JSON.parse(e.target.result);
                        
                        if (confirm('导入设置将覆盖当前设置，确定要继续吗？')) {
                            // 导入设置
                            if (settings.userSettings) {
                                AppState.userSettings = settings.userSettings;
                                applyUserSettings();
                            }
                            
                            if (settings.characters) {
                                AppState.characters = settings.characters;
                                renderCharacters();
                            }
                            
                            if (settings.worldbooks) {
                                AppState.worldbooks = settings.worldbooks;
                                renderWorldbooks();
                            }
                            
                            if (settings.worldbookCategories) {
                                AppState.worldbookCategories = settings.worldbookCategories;
                                renderWorldbookCategories();
                                renderWorldbookCategoryOptions();
                            }
                            
                            if (settings.apiPresets) {
                                AppState.apiPresets = settings.apiPresets;
                                renderApiPresets();
                            }
                            
                            if (settings.worldbookMounts) {
                                AppState.worldbookMounts = settings.worldbookMounts;
                            }
                            
                            if (settings.chatBackgrounds) {
                                AppState.chatBackgrounds = settings.chatBackgrounds;
                            }
                            
                            if (settings.customCSS) {
                                AppState.customCSS = settings.customCSS;
                                applyCustomCSS(settings.customCSS);
                            }
                            
                            saveDataToLocalStorage('all');
                            alert('设置导入成功！');
                        }
                    } catch (error) {
                        alert('导入失败：文件格式错误');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 重置设置
        function resetSettings() {
            if (confirm('确定要重置所有美化设置吗？此操作不可撤销。')) {
                // 重置用户设置中的美化部分
                AppState.userSettings.font = 'default';
                AppState.userSettings.avatarFrame = 'default';
                AppState.userSettings.chatBubble = 'default';
                AppState.userSettings.customAvatarFrameCSS = '';
                AppState.userSettings.customChatBubbleCSS = '';
                AppState.userSettings.customFontLink = '';
                AppState.customCSS = '';
                
                // 移除自定义CSS
                const customStyle = document.getElementById('custom-css-style');
                if (customStyle) {
                    customStyle.remove();
                }
                
                // 应用重置
                document.body.className = 'font-default';
                applyUserSettings();
                applyAvatarFrame('default');
                saveDataToLocalStorage(['userSettings', 'custom_css']);
                
                // 重新渲染美化选项
                renderBeautifyOptions();
                
                alert('美化设置已重置为默认值');
            }
        }
        
        // 打开设置对话框
        function openSettingsModal() {
            const settingsModal = document.getElementById('settingsModal');
            
            // 填充当前设置
            document.getElementById('userNameInput').value = AppState.userSettings.name;
            document.getElementById('userBioInput').value = AppState.userSettings.bio || '';
            document.getElementById('userAvatarInput').value = AppState.userSettings.avatar || '';
            document.getElementById('userCoverInput').value = AppState.userSettings.cover || '';
            document.getElementById('showDiaryNav').checked = AppState.userSettings.showDiaryNav;
            document.getElementById('showBeautifyNav').checked = AppState.userSettings.showBeautifyNav;
            document.getElementById('aiResponseDelay').value = AppState.userSettings.aiResponseDelay;
            document.getElementById('delayValue').textContent = `${AppState.userSettings.aiResponseDelay}ms`;
            document.getElementById('enableTypingEffect').checked = AppState.userSettings.enableTypingEffect;
            document.getElementById('enableHumanLike').checked = AppState.userSettings.enableHumanLike;
            document.getElementById('enableEmotions').checked = AppState.userSettings.enableEmotions;
            
            // 更新延迟值显示
            document.getElementById('aiResponseDelay').addEventListener('input', function() {
                document.getElementById('delayValue').textContent = `${this.value}ms`;
            });
            
            // 显示对话框
            settingsModal.classList.add('active');
            
            // 添加保存按钮事件
            document.getElementById('saveSettingsBtn').onclick = function() {
                // 保存设置
                AppState.userSettings.name = document.getElementById('userNameInput').value.trim() || '用户';
                AppState.userSettings.bio = document.getElementById('userBioInput').value.trim() || '';
                AppState.userSettings.avatar = document.getElementById('userAvatarInput').value.trim() || '';
                AppState.userSettings.cover = document.getElementById('userCoverInput').value.trim() || '';
                AppState.userSettings.showDiaryNav = document.getElementById('showDiaryNav').checked;
                AppState.userSettings.showBeautifyNav = document.getElementById('showBeautifyNav').checked;
                AppState.userSettings.aiResponseDelay = parseInt(document.getElementById('aiResponseDelay').value);
                AppState.userSettings.enableTypingEffect = document.getElementById('enableTypingEffect').checked;
                AppState.userSettings.enableHumanLike = document.getElementById('enableHumanLike').checked;
                AppState.userSettings.enableEmotions = document.getElementById('enableEmotions').checked;
                
                // 更新用户头像和封面
                updateUserAvatar(AppState.userSettings.avatar);
                if (AppState.userSettings.cover) {
                    document.getElementById('userCover').style.backgroundImage = `url('${AppState.userSettings.cover}')`;
                    document.getElementById('userCover').style.backgroundSize = 'cover';
                    document.getElementById('userCover').style.backgroundPosition = 'center';
                }
                
                // 应用设置
                applyUserSettings();
                updateNavVisibility();
                saveDataToLocalStorage('userSettings');
                
                // 关闭对话框
                settingsModal.classList.remove('active');
                
                alert('设置已保存');
            };
            
            // 添加取消按钮事件
            document.getElementById('cancelSettingsBtn').onclick = function() {
                settingsModal.classList.remove('active');
            };
            
            // 添加导出数据按钮事件
            document.getElementById('exportDataBtn').onclick = function() {
                const data = {
                    characters: AppState.characters,
                    chats: AppState.chats,
                    diaries: AppState.diaries,
                    moments: AppState.moments,
                    worldbooks: AppState.worldbooks,
                    worldbookCategories: AppState.worldbookCategories,
                    apiPresets: AppState.apiPresets,
                    userSettings: AppState.userSettings,
                    worldbookMounts: AppState.worldbookMounts,
                    chatBackgrounds: AppState.chatBackgrounds,
                    customCSS: AppState.customCSS,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileName = `rynx-data-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                alert('数据已导出为JSON文件');
            };
            
            // 添加导入数据按钮事件
            document.getElementById('importDataBtn').onclick = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) {
                                // 导入数据
                                if (data.characters) AppState.characters = data.characters;
                                if (data.chats) AppState.chats = data.chats;
                                if (data.diaries) AppState.diaries = data.diaries;
                                if (data.moments) AppState.moments = data.moments;
                                if (data.worldbooks) AppState.worldbooks = data.worldbooks;
                                if (data.worldbookCategories) AppState.worldbookCategories = data.worldbookCategories;
                                if (data.apiPresets) AppState.apiPresets = data.apiPresets;
                                if (data.userSettings) AppState.userSettings = data.userSettings;
                                if (data.worldbookMounts) AppState.worldbookMounts = data.worldbookMounts;
                                if (data.chatBackgrounds) AppState.chatBackgrounds = data.chatBackgrounds;
                                if (data.customCSS) {
                                    AppState.customCSS = data.customCSS;
                                    applyCustomCSS(data.customCSS);
                                }
                                
                                // 保存到本地存储
                                saveDataToLocalStorage('all');
                                
                                // 重新渲染所有内容
                                applyUserSettings();
                                updateNavVisibility();
                                renderChatList();
                                renderMoments();
                                renderWorldbookCategories();
                                renderWorldbookCategoryOptions();
                                renderWorldbooks();
                                renderApiPresets();
                                renderCharacters();
                                renderDiaries();
                                renderBeautifyOptions();
                                updateUnreadBadge();
                                
                                alert('数据导入成功！');
                            }
                        } catch (error) {
                            alert('导入失败：文件格式错误');
                            console.error(error);
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            };
            
            // 添加清空数据按钮事件
            document.getElementById('clearDataBtn').onclick = function() {
                if (confirm('确定要清空所有数据吗？此操作不可撤销。')) {
                    // 清空所有数据
                    AppState.characters = [];
                    AppState.chats = [];
                    AppState.diaries = [];
                    AppState.moments = [];
                    AppState.worldbooks = [];
                    
                    // 重置API预设为默认值
                    AppState.apiPresets = getDefaultApiPresets();
                    AppState.currentApiPreset = AppState.apiPresets[0];
                    
                    // 重置用户设置
                    AppState.userSettings = {
                        name: '用户',
                        bio: '这个人很懒，什么都没写',
                        avatar: '',
                        cover: '',
                        theme: 'light',
                        font: 'default',
                        avatarFrame: 'default',
                        chatBubble: 'default',
                        showDiaryNav: true,
                        showBeautifyNav: true,
                        aiResponseDelay: 1500,
                        enableTypingEffect: true,
                        enableHumanLike: true,
                        enableEmotions: true,
                        customAvatarFrameCSS: '',
                        customChatBubbleCSS: '',
                        customFontLink: ''
                    };
                    
                    // 重置其他数据
                    AppState.userBalance = 1000.00;
                    AppState.worldbookMounts = {};
                    AppState.chatBackgrounds = {};
                    AppState.customCSS = '';
                    
                    // 保存到本地存储
                    saveDataToLocalStorage('all');
                    
                    // 重新渲染所有内容
                    applyUserSettings();
                    updateNavVisibility();
                    renderChatList();
                    renderMoments();
                    renderWorldbookCategories();
                    renderWorldbookCategoryOptions();
                    renderWorldbooks();
                    renderApiPresets();
                    renderCharacters();
                    renderDiaries();
                    renderBeautifyOptions();
                    updateUnreadBadge();
                    
                    // 关闭对话框
                    settingsModal.classList.remove('active');
                    
                    alert('所有数据已清空');
                }
            };
        }
        
        // 立即启动应用
        document.addEventListener('DOMContentLoaded', function() {
            // 立即显示主应用，无需等待
            splashScreen.classList.add('splash-hidden');
            setTimeout(() => {
                appContainer.classList.add('app-visible');
                initializeApp();
            }, 300);
        });
    </script>
</body>
</html>
